# Plan: Workstream Review Standardization

> **Stream ID:** 014-workstream-review-standardization | **Created:** 2026-01-26 | **Generated by:** @agenv/workstreams@0.1.0

## Summary

Standardize the workstream review/evaluation process by introducing a structured REPORT.md file that agents fill out upon workstream completion. This replaces the current ad-hoc evaluation approach with a "structured markdown" template system. Additionally, improve git commit tracking, migrate GitHub issues from per-thread to per-stage, and create a dedicated `github.json` file for issue management.

## References

- `agent/skills/evaluating-workstreams/SKILL.md` - Current evaluation skill
- `packages/workstreams/src/lib/reports.ts` - Stage report generation
- `packages/workstreams/src/lib/github/commits.ts` - Git commit helpers
- `packages/workstreams/src/lib/github/sync.ts` - GitHub issue sync
- `packages/workstreams/src/cli/report.ts` - Report CLI command
- `packages/workstreams/src/cli/review.ts` - Review CLI command

## Stages

### Stage 01: REPORT.md Template System

#### Stage Definition

Create a structured REPORT.md template that can be generated at workstream creation and filled out by agents during evaluation. The template follows the "structured markdown" approach similar to PLAN.md.

#### Stage Constitution

**Inputs:**
- Workstream metadata (name, stages, batches, threads)
- Task data from tasks.json
- Git commit information

**Structure:**
- Template generation happens during `work create`
- Agent fills sections during evaluation
- CLI commands for validation and display

**Outputs:**
- REPORT.md template file in workstream directory
- Updated evaluating-workstreams skill
- CLI commands for report management

#### Stage Questions

- [x] Should REPORT.md include metrics? No - metrics are in COMPLETION.md
- [x] Should we keep COMPLETION.md separate? Yes - COMPLETION.md is auto-generated, REPORT.md is agent-written

#### Stage Batches

##### Batch 01: Template & Types

Create the REPORT.md template structure and TypeScript types.

###### Thread 01: REPORT.md Template Design

**Summary:**
Define the REPORT.md template structure and create the generator function.

**Details:**
- Working packages: `packages/workstreams/src/lib`
- Template structure:
  ```markdown
  # Report: {Workstream Name}
  
  > **Stream ID:** {id} | **Reported:** {date}
  
  ## Summary
  <!-- High-level summary of what was achieved -->
  
  ## Accomplishments
  
  ### Stage 01: {Stage Name}
  <!-- What was accomplished in this stage -->
  
  #### Key Changes
  - {description}
  
  ## File References
  
  | File | Changes |
  |------|---------|
  | `path/to/file.ts` | Description of changes |
  
  ## Issues & Blockers
  <!-- Any issues encountered, bugs found, or blockers hit -->
  
  ## Next Steps
  <!-- Recommended follow-up work -->
  ```
- Create `generateReportTemplate()` function
- Add type definitions for report sections

###### Thread 02: Docs Directory Structure

**Summary:**
Add optional `docs/` directory to workstream structure for additional documentation.

**Details:**
- Working packages: `packages/workstreams/src/lib`
- Create `docs/` directory during `work create`
- Add README.md in docs/ explaining its purpose
- Update workstream types to include docs path
- Mention in skills that agents can add extra documentation here

##### Batch 02: CLI & Skill Integration

Integrate REPORT.md into CLI commands and update the evaluation skill.

###### Thread 01: CLI Report Commands

**Summary:**
Add CLI commands for generating and validating REPORT.md.

**Details:**
- Working packages: `packages/workstreams/src/cli`
- Add `work report generate` to create REPORT.md from template
- Add `work report validate` to check required sections are filled
- Update `work create` to generate REPORT.md template
- Consider merging/consolidating existing report commands

###### Thread 02: Update Evaluating Skill

**Summary:**
Update the evaluating-workstreams skill to guide agents in filling out REPORT.md.

**Details:**
- Working packages: `agent/skills/evaluating-workstreams`
- Update SKILL.md with new workflow
- Add instructions for filling each section
- Add guidance on docs/ directory usage
- Include examples of good report content

### Stage 02: Git Commit Improvements

#### Stage Definition

Improve the git commit message format and fix parsing issues so that commit history is more useful for reviews and reports.

#### Stage Constitution

**Inputs:**
- Current commit format from `commits.ts`
- Current parsing logic from `log.ts`
- Stage approval workflow

**Structure:**
- Enhance commit trailers
- Fix date parsing issues
- Improve commit display

**Outputs:**
- Enhanced commit messages with more context
- Fixed commit parsing
- Better commit display in review commands

#### Stage Questions

- [x] Should we add Stream-Name trailer? Yes - improves readability
- [x] Should we add Stage-Name trailer? Yes - improves context

#### Stage Batches

##### Batch 01: Enhanced Commit Format

Improve the commit message format with additional trailers.

###### Thread 01: Commit Message Trailers

**Summary:**
Add Stream-Name and Stage-Name trailers to stage approval commits.

**Details:**
- Working packages: `packages/workstreams/src/lib/github`
- Update `formatStageCommitMessage()` in `commits.ts`
- Add `Stream-Name: {name}` trailer
- Add `Stage-Name: {name}` trailer
- Keep existing trailers for backwards compatibility
- Format example:
  ```
  Stage 1 approved: Foundation
  
  Approved stage 1 of workstream 014-workstream-review.
  
  Stream-Id: 014-workstream-review
  Stream-Name: Workstream Review Standardization
  Stage: 1
  Stage-Name: Foundation
  ```

###### Thread 02: Trailer Parsing Updates

**Summary:**
Update trailer extraction to support new trailers and fix date parsing.

**Details:**
- Working packages: `packages/workstreams/src/lib/git`
- Update `extractWorkstreamTrailers()` in `log.ts`
- Add parsing for `Stream-Name` and `Stage-Name`
- Update `WorkstreamTrailers` interface
- Fix date parsing fallback in review.ts `formatCommit()`

##### Batch 02: Review Command Improvements

Improve the `work review commits` output.

###### Thread 01: Enhanced Commit Display

**Summary:**
Improve commit display with stage names and better formatting.

**Details:**
- Working packages: `packages/workstreams/src/cli`
- Update `formatCommitOutput()` in `review.ts`
- Use Stage-Name from trailers when available
- Add file change summaries (added/modified/deleted counts)
- Group files by type or directory for readability

### Stage 03: GitHub Issues Per Stage

#### Stage Definition

Migrate GitHub issue management from per-thread to per-stage, and create a dedicated `github.json` file in each workstream directory for tracking.

#### Stage Constitution

**Inputs:**
- Current thread-based issue system in `sync.ts`
- Current storage in `tasks.json` under `github_issue`
- Stage completion events

**Structure:**
- Create new `github.json` file format
- Migrate issue creation to stage-level
- Update sync logic

**Outputs:**
- New `github.json` file per workstream
- Stage-level GitHub issues
- Updated CLI commands

#### Stage Questions

- [x] Keep backwards compatibility? No - early development, all workstreams completed

#### Stage Batches

##### Batch 01: GitHub.json Structure

Create the new github.json file and types.

###### Thread 01: GitHub.json File Format

**Summary:**
Define and implement the github.json file structure for workstreams.

**Details:**
- Working packages: `packages/workstreams/src/lib/github`
- New file: `packages/workstreams/src/lib/github/workstream-issues.ts`
- Structure:
  ```typescript
  interface WorkstreamGitHub {
    version: string
    stream_id: string
    last_updated: string
    branch?: {
      name: string
      url: string
      created_at: string
    }
    stages: {
      [stageNumber: string]: {
        issue_number: number
        issue_url: string
        state: "open" | "closed"
        created_at: string
        closed_at?: string
      }
    }
  }
  ```
- Create `loadGitHubJson()`, `saveGitHubJson()` functions
- Create during `work create` or `work github enable`

###### Thread 02: Remove Thread Issue Storage

**Summary:**
Remove github_issue storage from tasks.json and threads.json.

**Details:**
- Working packages: `packages/workstreams/src/lib`
- Remove `github_issue` field from Task type
- Remove `githubIssue` field from ThreadMetadata type
- Update any code that reads these fields
- Clean migration: these fields simply won't be used anymore

##### Batch 02: Stage Issue Commands

Update CLI commands for stage-level issues.

###### Thread 01: Create Stage Issues

**Summary:**
Update `work github create-issues` to create one issue per stage.

**Details:**
- Working packages: `packages/workstreams/src/cli`, `packages/workstreams/src/lib/github`
- Modify `createIssuesForWorkstream()` in `sync.ts`
- Create issue per stage instead of per thread
- Issue title: `[{stream-id}] Stage {N}: {Stage Name}`
- Issue body: List of batches/threads/tasks
- Store in github.json instead of tasks.json

###### Thread 02: Sync Stage Issues

**Summary:**
Update `work github sync` to sync stage-level issues.

**Details:**
- Working packages: `packages/workstreams/src/lib/github`
- Update `syncIssueStates()` to work with stages
- Close issue when all tasks in stage are completed
- Update github.json state on sync
- Remove thread-level sync logic

###### Thread 03: Stage Approval Integration

**Summary:**
Optionally close GitHub issue when stage is approved.

**Details:**
- Working packages: `packages/workstreams/src/cli/approve`
- In stage approval, check if stage has GitHub issue
- Add option to close issue on approval (since approval means stage is complete)
- Update github.json with closed_at timestamp

### Stage 04: Skill Refinement & Cleanup

#### Stage Definition

Update all workstream skills, clean up redundant commands, and ensure documentation is complete.

#### Stage Constitution

**Inputs:**
- Updated REPORT.md system
- Updated GitHub integration
- All existing skills

**Structure:**
- Audit and update skills
- Remove/consolidate redundant commands
- Update documentation

**Outputs:**
- Clean, consistent skill documentation
- Streamlined command set
- Updated README and docs

#### Stage Questions

- [x] Which commands might be redundant? `work report`, `work export`, `work metrics` have overlapping functionality

#### Stage Batches

##### Batch 01: Skill Updates

Update all workstream skills with new workflows.

###### Thread 01: Evaluating Skill Final

**Summary:**
Finalize the evaluating-workstreams skill with complete workflow.

**Details:**
- Working packages: `agent/skills/evaluating-workstreams`
- Document complete evaluation workflow:
  1. `work status` - Check completion status
  2. `work review commits` - Review all changes
  3. Fill REPORT.md sections
  4. Add extra docs to `docs/` if needed
  5. `work report validate` - Validate report
- Include example REPORT.md content

###### Thread 02: Other Skills Review

**Summary:**
Review and update other skills for consistency.

**Details:**
- Working packages: `agent/skills/*`
- Check implementing-workstreams for any needed updates
- Check synthesizing-workstreams for consistency
- Ensure all skills reference new command structure
- Add cross-references between related skills

##### Batch 02: Command Audit & Docs

Audit commands and update documentation.

###### Thread 01: Command Consolidation

**Summary:**
Identify and consolidate redundant report-related commands.

**Details:**
- Working packages: `packages/workstreams/src/cli`
- Audit: `work report`, `work export`, `work metrics`, `work changelog`
- Determine which to keep/merge/deprecate
- `work report` - Keep (main report command)
- `work export` - Keep (different purpose: CSV/JSON export)
- `work metrics` - Consider merging into report
- `work changelog` - Keep (useful for git history)
- Document decisions and update help text

###### Thread 02: Documentation Update

**Summary:**
Update all documentation to reflect changes.

**Details:**
- Working packages: `docs/`
- Update docs/opencode-commands.md with any new commands
- Create docs/workstream-reports.md explaining REPORT.md
- Update README.md if needed
- Ensure all CLI --help text is accurate

---

*Last updated: 2026-01-26*

### Stage 05: Revision - Report Validation on Complete

#### Stage Definition

Make `work complete` validate that REPORT.md exists and has required sections filled before allowing workstream completion.

#### Stage Constitution

**Inputs:**
- Existing `work complete` command in `packages/workstreams/src/cli/complete.ts`
- Report validation functions from Stage 01

**Structure:**
- Add REPORT.md check to complete command
- Provide --force flag to skip validation if needed

**Outputs:**
- Updated complete command that enforces REPORT.md
- Clear error messages when report is missing/incomplete

#### Stage Questions

- [x] Should we allow --force to skip? Yes, for edge cases

#### Stage Batches

##### Batch 01: Complete Command Validation

###### Thread 01: Add Report Check to Complete

**Summary:**
Update `work complete` to require a valid REPORT.md before marking workstream as complete.

**Details:**
- Working packages: `packages/workstreams/src/cli`
- In `complete.ts`, add check for REPORT.md existence
- Use `validateReport()` from report-template.ts to check content
- If missing/invalid, show error with instructions to run `work report init`
- Add `--force` flag to bypass validation (with warning)
- Update help text to document the requirement
