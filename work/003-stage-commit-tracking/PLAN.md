# Plan: Stage Commit Tracking

> **Stream ID:** 003-stage-commit-tracking | **Created:** 2026-01-22 | **Generated by:** @agenv/workstreams@0.1.0

## Summary

Implement automatic git commit creation when stages are approved, with structured commit messages that enable tracking of file changes per stage. Add a `work review commits` command that parses the git history to show commits grouped by stage, distinguishing between automated stage-approval commits and human commits made in between. This enables the evaluating-workstreams skill to analyze which files were modified in each stage.

## References

- Working package: `./packages/workstreams`
- CLI handlers: `./packages/workstreams/src/cli/`
- Library functions: `./packages/workstreams/src/lib/`
- GitHub integration: `./packages/workstreams/src/lib/github/`
- Approval logic: `./packages/workstreams/src/lib/approval.ts`
- Evaluating skill: `./skills/evaluating-workstreams/SKILL.md`

## Design Decisions

### Commit Message Format

Use structured commit messages with git trailers (machine-parseable):

```
[003-stage-commit-tracking] Stage 01: Setup approved

Stage approval commit for workstream.

Workstream-Id: 003-stage-commit-tracking
Workstream-Stage: 01
Workstream-Stage-Name: Setup
```

### No Git Tags

**Decision:** Do NOT use git tags for stage approvals.

**Rationale:**
- With dozens of workstreams and 3-6 stages each, tags would create hundreds of entries
- Workstream branches are merged and deleted, making tags orphaned references
- Commit message trailers provide the same filtering capability via `git log --grep`
- Tags add management overhead (cleanup, namespace collisions)

### Commit SHA Storage

Store the commit SHA in the stage approval metadata in `index.json`:

```json
{
  "approval": {
    "stages": {
      "1": {
        "status": "approved",
        "approved_at": "...",
        "commit_sha": "abc123..."
      }
    }
  }
}
```

## Stages

### Stage 01: Auto-Commit on Stage Approval

#### Stage Definition

Implement automatic git commit creation when a stage is approved (if GitHub integration is enabled). The commit captures all staged and unstaged changes at the moment of approval, creating a clear checkpoint in git history.

#### Stage Constitution

**Inputs:**
- Current approval flow in `packages/workstreams/src/cli/approve.ts`
- GitHub config check pattern from existing code
- Git operations pattern from `packages/workstreams/src/cli/complete.ts`

**Structure:**
- Add `createStageApprovalCommit()` function in `src/lib/github/commits.ts`
- Modify approval CLI to call commit function after successful stage approval
- Store commit SHA in stage approval metadata

**Outputs:**
- New file: `src/lib/github/commits.ts` with commit creation logic
- Modified: `packages/workstreams/src/cli/approve.ts` to trigger commits
- Modified: `src/lib/approval.ts` to store commit SHA in metadata
- Updated types for approval metadata with commit SHA

#### Stage Questions

- [x] Should we commit only staged changes or all changes? → All changes (git add -A) to capture complete state
- [x] What if there are no changes to commit? → Skip commit, log message, still approve
- [x] Should this be configurable? → Yes, add `auto_commit_on_approval` to github.json config (default: true when github enabled)

#### Stage Batches

##### Batch 01: Core Implementation

Implement the commit creation logic and integrate with approval flow.

###### Thread 01: Commit Library

**Summary:**
Create the git commit helper functions for stage approval commits.

**Details:**
- Working package: `./packages/workstreams`
- Create `src/lib/github/commits.ts` with:
  - `formatStageCommitMessage(streamId, stageNum, stageName)` - formats message with trailers
  - `createStageApprovalCommit(repoRoot, stream, stageNum)` - performs git add, commit, returns SHA
  - `hasUncommittedChanges(repoRoot)` - checks if there are changes to commit
- Use `child_process.execSync` for git commands (consistent with complete.ts pattern)
- Handle errors gracefully - commit failure should not block approval

###### Thread 02: Approval Integration

**Summary:**
Integrate commit creation into the stage approval flow.

**Details:**
- Working package: `./packages/workstreams`
- Modify `packages/workstreams/src/cli/approve.ts`:
  - After successful stage approval, check if GitHub integration enabled
  - Check new config flag `auto_commit_on_approval`
  - Call `createStageApprovalCommit()` if enabled
  - Store returned commit SHA in stage approval metadata
- Modify `src/lib/approval.ts`:
  - Add `commit_sha?: string` to stage approval metadata type
  - Add function to store commit SHA after approval
- Modify `src/lib/github/config.ts`:
  - Add `auto_commit_on_approval: boolean` to config type (default: true)

### Stage 02: Review Commits Command

#### Stage Definition

Create a new `work review commits` CLI command that parses git history for the current workstream branch, groups commits by stage (using the trailer markers), and identifies human commits made between stage approval commits.

#### Stage Constitution

**Inputs:**
- Commit SHA metadata stored in stage approvals (from Stage 01)
- Git log parsing with trailer detection
- Workstream branch name from metadata

**Structure:**
- New CLI command in `packages/workstreams/src/cli/review-commits.ts`
- Register command in `bin/work.ts`
- Parse git log output to extract trailers and group commits

**Outputs:**
- New file: `packages/workstreams/src/cli/review-commits.ts`
- Modified: `bin/work.ts` to register command
- Formatted output showing commits per stage with human commits highlighted

#### Stage Questions

- [x] How to identify the start of the workstream? → Use branch point from main, or first commit with workstream trailer
- [x] Should we show file changes? → Yes, include `--stat` output for each commit
- [x] Output format? → Human-readable by default, `--json` flag for machine parsing

#### Stage Batches

##### Batch 01: Command Implementation

###### Thread 01: Git Log Parser

**Summary:**
Implement git log parsing to extract commits with workstream trailers.

**Details:**
- Working package: `./packages/workstreams`
- Create parsing functions in `src/lib/git/log.ts`:
  - `parseGitLog(repoRoot, branchName)` - get all commits on branch
  - `extractWorkstreamTrailers(commitMessage)` - parse trailers from message
  - `groupCommitsByStage(commits, streamId)` - organize commits by stage
  - `identifyHumanCommits(commits)` - find commits without workstream trailers
- Use `git log --format` with custom format to get SHA, message, author, date, files

###### Thread 02: CLI Command

**Summary:**
Implement the `work review commits` CLI command with output formatting.

**Details:**
- Working package: `./packages/workstreams`
- Create `packages/workstreams/src/cli/review-commits.ts`:
  - Parse args: `--stream`, `--stage`, `--json`, `--files`
  - Default to current workstream
  - Call git log parser functions
  - Format output grouped by stage
- Output format (human-readable):
  ```
  Workstream: 003-stage-commit-tracking
  Branch: workstream/003-stage-commit-tracking

  ## Stage 01: Setup

  ### Stage Approval Commit
  - abc123 [2026-01-22] Stage 01: Setup approved
    Files: src/lib/foo.ts, packages/workstreams/src/cli/bar.ts (+150, -20)

  ### Implementation Commits
  - def456 [2026-01-22] Add foo module
    Files: src/lib/foo.ts (+100, -0)
  - ghi789 [2026-01-22] Add bar command
    Files: packages/workstreams/src/cli/bar.ts (+50, -20)

  ### Human Commits (manual/external)
  - jkl012 [2026-01-22] Quick fix for typo
    Files: README.md (+1, -1)

  ## Stage 02: Testing
  ...
  ```
- Register in `bin/work.ts` as `"review-commits": reviewCommitsMain`

### Stage 03: Documentation and Skill Update

#### Stage Definition

Update the README documentation for the workstreams package and modify the evaluating-workstreams skill to use the new `work review commits` command for analyzing stage changes.

#### Stage Constitution

**Inputs:**
- Completed implementation from Stages 01 and 02
- Existing README structure
- Current evaluating-workstreams skill

**Structure:**
- Add documentation section for auto-commit feature
- Add CLI reference for `work review commits`
- Update skill with commit review workflow

**Outputs:**
- Modified: `packages/workstreams/README.md`
- Modified: `skills/evaluating-workstreams/SKILL.md`

#### Stage Questions

- [x] Should we document the trailer format for external tooling? → Yes, document in README

#### Stage Batches

##### Batch 01: Documentation

###### Thread 01: README Update

**Summary:**
Add documentation for the new auto-commit and review commits features.

**Details:**
- Working package: `./packages/workstreams`
- Add section "Stage Approval Commits" under GitHub Integration
- Document:
  - How auto-commit works on stage approval
  - The commit message format with trailers
  - The `auto_commit_on_approval` config option
- Add CLI reference for `work review commits` command
- Include examples of the output format

###### Thread 02: Skill Update

**Summary:**
Update the evaluating-workstreams skill to use commit review.

**Details:**
- Working file: `./skills/evaluating-workstreams/SKILL.md`
- Add new section "Review Stage Commits" with:
  ```bash
  work review commits              # Show all commits by stage
  work review commits --stage 1    # Show commits for specific stage
  work review commits --files      # Include detailed file changes
  work review commits --json       # Machine-readable output
  ```
- Update evaluation workflow to include:
  1. Review commits per stage
  2. Identify files modified in each stage
  3. Cross-reference with plan to verify scope
  4. Note any human commits for context

---

*Last updated: 2026-01-22*
