# Plan: Workstreams UX Improvements

> **Stream ID:** 009-workstreams-ux-improvements | **Created:** 2026-01-23 | **Generated by:** @agenv/workstreams@0.1.0

## Summary

This workstream improves the workstreams CLI user experience across four key areas:
1. **Notification System** - Play sounds when threads complete, with extensibility for custom sounds and external API integrations
2. **Thread Metadata Refactor** - Move sessions and github issues out of tasks.json into a dedicated threads.json for better separation of concerns
3. **Tmux Multi-View Fixes** - Fix the 2x2 grid layout, improve test coverage, and add preview scripts for testing
4. **Fix Command Enhancement** - Run retry operations within tmux sessions like `multi` does

## References

- `packages/workstreams/src/lib/tmux.ts` - Tmux session management
- `packages/workstreams/src/cli/multi.ts` - Multi-thread execution
- `packages/workstreams/src/cli/multi-grid.ts` - Grid controller
- `packages/workstreams/src/cli/fix.ts` - Fix command
- `packages/workstreams/src/lib/tasks.ts` - Task/session tracking
- `packages/workstreams/src/lib/types.ts` - Type definitions

## Stages

### Stage 01: Core Infrastructure

#### Stage Definition

Establishes foundational infrastructure: the notification system architecture and the threads.json data model. These are independent building blocks that later stages depend on.

#### Stage Constitution

**Inputs:**
- `packages/workstreams/src/lib/tasks.ts` with session tracking
- `packages/workstreams/src/lib/types.ts` with SessionRecord and github_issue definitions
- macOS `afplay` command for audio playback

**Structure:**
- Two parallel threads: notification library + threads.json migration
- Each thread produces testable, isolated modules

**Outputs:**
- `src/lib/notifications.ts` - Notification service with sound playback and extensibility hooks
- `src/lib/threads.ts` - Thread metadata management (sessions, github issues)
- `threads.json` schema and migration utilities
- Unit tests for both modules

#### Stage Questions

- [x] Should threads.json live in the workstream directory (work/{id}/) or globally? **Answer: In workstream directory alongside tasks.json**
- [x] What macOS sounds should be defaults? **Answer: Use system sounds via afplay, e.g., /System/Library/Sounds/Glass.aiff for success**

#### Stage Batches

##### Batch 01: Foundation

Build the core libraries for notifications and thread metadata.

###### Thread 01: Notification System

**Summary:**
Create a notification library that plays sounds on macOS with extensibility for custom sounds and external API hooks.

**Details:**
- Working packages: `./packages/workstreams`
- Create `src/lib/notifications.ts` with:
  - `NotificationProvider` interface for extensibility
  - `MacOSSoundProvider` - Default implementation using `afplay`
  - `playNotification(event: 'thread_complete' | 'batch_complete' | 'error')` function
  - Configuration loading from `~/.config/agenv/notifications.json` for custom sounds
  - `ExternalApiProvider` stub interface for future webhook/API integrations
- Default sounds from macOS system sounds (`/System/Library/Sounds/`)
- Async/non-blocking playback (spawn process, don't await)
- Create `tests/notifications.test.ts` with mocked audio playback

###### Thread 02: Thread Metadata Store

**Summary:**
Create threads.json to store session history and github issue links, migrating this data out of tasks.json.

**Details:**
- Working packages: `./packages/workstreams`
- Create `src/lib/threads.ts` with:
  - `ThreadMetadata` interface: `{ threadId, sessions: SessionRecord[], githubIssue?, currentSessionId? }`
  - `ThreadsStore` class for CRUD operations on threads.json
  - `loadThreads(streamPath)`, `saveThreads(streamPath, data)`
  - `getThreadMetadata(threadId)`, `updateThreadMetadata(threadId, data)`
  - `migrateFromTasksJson(streamPath)` - One-time migration utility
  - File locking using `proper-lockfile` (same pattern as tasks.ts)
- Update `src/lib/types.ts`:
  - Add `ThreadsJson` schema type
  - Add `ThreadMetadata` interface
- Create `tests/threads.test.ts` with:
  - CRUD operation tests
  - Migration tests
  - Concurrent access tests

### Stage 02: Integration

#### Stage Definition

Integrate the new notification and threads.json systems into existing code paths. Update tasks.ts to delegate session operations to threads.ts, and wire notifications into multi.ts completion handlers.

#### Stage Constitution

**Inputs:**
- Stage 01 outputs (notifications.ts, threads.ts)
- `packages/workstreams/src/lib/tasks.ts`
- `packages/workstreams/src/cli/multi.ts`
- `packages/workstreams/src/cli/fix.ts`

**Structure:**
- Two parallel threads: tasks.ts refactor + notification integration
- Must maintain backward compatibility during transition

**Outputs:**
- tasks.ts updated to use threads.ts for session management
- multi.ts plays notifications on thread/batch completion
- Backward-compatible migration path

#### Stage Questions

- [x] Should we auto-migrate existing tasks.json on first read? **Answer: Yes, with backup**

#### Stage Batches

##### Batch 01: System Integration

Wire the new libraries into existing code paths.

###### Thread 01: Tasks.ts Refactor

**Summary:**
Update tasks.ts to delegate session tracking to threads.ts while maintaining the existing API surface.

**Details:**
- Working packages: `./packages/workstreams`
- Modify `src/lib/tasks.ts`:
  - Import and use `ThreadsStore` from threads.ts
  - Update `startTaskSession()` to write to threads.json via ThreadsStore
  - Update `completeTaskSession()` to write to threads.json
  - Update `getCurrentTaskSession()` to read from threads.json
  - Update `getTaskSessions()` to read from threads.json
  - Keep Task interface in types.ts but mark session fields as deprecated
  - Add migration check on load: if sessions exist in tasks.json, migrate them
- Ensure all locked variants (`*Locked()` functions) use threads.ts internally
- Update `tests/session-tracking.test.ts` to verify data goes to threads.json
- Run existing tests to ensure no regressions

###### Thread 02: Notification Integration

**Summary:**
Wire notification sounds into multi.ts thread completion events.

**Details:**
- Working packages: `./packages/workstreams`
- Modify `src/cli/multi.ts`:
  - Import notification service from `src/lib/notifications.ts`
  - In `waitForAllPanesExit()` callback or status polling loop, detect thread completion
  - Call `playNotification('thread_complete')` when a thread completes
  - Call `playNotification('batch_complete')` when all threads in batch complete
  - Call `playNotification('error')` on thread failure
- Add `--silent` flag to multi command to disable sounds
- Update `tests/multi.test.ts` with notification integration tests (mocked)

### Stage 03: Tmux & Fix Command

#### Stage Definition

Fix the tmux 2x2 grid layout issues, enhance test coverage for tmux operations, add preview scripts for manual testing, and update the fix command to run retries in tmux like multi does.

#### Stage Constitution

**Inputs:**
- Stage 02 outputs (integrated systems)
- `packages/workstreams/src/lib/tmux.ts`
- `packages/workstreams/src/cli/multi-grid.ts`
- `packages/workstreams/src/cli/fix.ts`
- Known issue: grid creates single panel on right, 3 stacked on left instead of 2x2

**Structure:**
- Three parallel threads: grid fix, test scripts, fix command enhancement
- Grid fix is independent; fix command depends on understanding tmux patterns

**Outputs:**
- Fixed 2x2 grid layout in tmux
- New unit tests for tmux operations
- Preview scripts in `./scripts/` for manual testing
- Fix command retry runs in tmux session

#### Stage Questions

- [x] What model should preview scripts use? **Answer: claude-3-5-haiku-latest (fast, cheap)**
- [x] Should fix --retry create a new tmux session or reuse existing? **Answer: Create new session like multi does**

#### Stage Batches

##### Batch 01: Tmux Improvements

Fix grid layout and add testing infrastructure.

###### Thread 01: Grid Layout Fix

**Summary:**
Debug and fix the 2x2 grid layout that currently creates an incorrect pane arrangement.

**Details:**
- Working packages: `./packages/workstreams`
- Investigate `src/lib/tmux.ts` `createGridLayout()` function (lines 309-371)
- Current issue: Creates 1 panel on right, 3 stacked on left instead of 2x2
- Debug the split sequence:
  1. Start with single pane
  2. Split horizontally (-h) to get [Left, Right]
  3. Split left vertically (-v) to get [TL, BL, Right]
  4. Split right vertically (-v) to get [TL, BL, TR, BR]
- Verify split percentages and target pane selection
- Fix the layout algorithm to produce correct 2x2 grid
- Add `tests/tmux-grid.test.ts` with layout verification tests
- Test with 1, 2, 3, 4 pane configurations

###### Thread 02: Tmux Test Scripts

**Summary:**
Create preview scripts in ./scripts/ for manual tmux testing with small models.

**Details:**
- Working packages: `./packages/workstreams`
- Create `scripts/preview-multi.ts`:
  - Accept `--threads N` argument (default 4)
  - Create mock prompts like "Say hello and exit" or "List files in current directory"
  - Run `work multi` equivalent with claude-3-5-haiku-latest model
  - Allow testing grid behavior without full workstream setup
- Create `scripts/preview-grid.ts`:
  - Standalone 2x2 grid tester
  - Create tmux session with 4 panes running simple commands
  - Verify layout visually
- Create `scripts/preview-fix.ts`:
  - Test fix command retry flow
  - Create mock failed thread, run fix --retry
- Add instructions to `scripts/README.md` for running preview scripts
- Scripts should be runnable with `bun run scripts/preview-*.ts`

###### Thread 03: Tmux Unit Tests

**Summary:**
Increase unit test coverage for tmux.ts operations.

**Details:**
- Working packages: `./packages/workstreams`
- Expand `tests/tmux.test.ts` with additional tests:
  - `createSession()` - Verify session creation and naming
  - `addWindow()` - Verify window creation
  - `splitWindow()` - Verify split operations
  - `createGridLayout()` - Verify 2x2 layout (mock or integration)
  - `getSessionPaneStatuses()` - Verify pane status parsing
  - `waitForAllPanesExit()` - Verify polling and completion detection
  - `respawnPane()` - Verify pane respawn
- Use tmux `-f /dev/null` to avoid user config interference in tests
- Add cleanup in test teardown to kill test sessions
- Target 80%+ coverage of tmux.ts functions

##### Batch 02: Fix Command Enhancement

###### Thread 01: Fix Command Tmux Integration

**Summary:**
Update fix --retry to run the agent thread within a tmux session like multi does.

**Details:**
- Working packages: `./packages/workstreams`
- Modify `src/cli/fix.ts`:
  - In retry action (lines 310-409), instead of running opencode directly:
  - Create a new tmux session with a descriptive name (e.g., `work-fix-{threadId}`)
  - Run the opencode command within the tmux session
  - Attach to the session so user sees output
  - On detach (Ctrl-B D), process continues in background
  - User can reattach later with `tmux attach -t work-fix-{threadId}`
- Reuse tmux helpers from `src/lib/tmux.ts`
- Update `--resume` to also work within tmux if a fix session exists
- Add `--no-tmux` flag to preserve old behavior (run in foreground)
- Update `tests/fix.test.ts` with tmux integration tests

### Stage 04: Documentation & Polish

#### Stage Definition

Final documentation updates, configuration examples, and cleanup of deprecated code paths.

#### Stage Constitution

**Inputs:**
- All previous stage outputs
- Working notification system, threads.json, fixed tmux, enhanced fix command

**Structure:**
- Single batch with documentation and cleanup threads

**Outputs:**
- Updated README with new features
- Configuration examples for notifications
- Migration guide for threads.json
- Deprecated code cleanup

#### Stage Questions

- [x] Should we remove deprecated session fields from tasks.json immediately or keep for one version? **Answer: Keep deprecated for one version with console warning**

#### Stage Batches

##### Batch 01: Finalization

###### Thread 01: Documentation

**Summary:**
Update documentation with new features and configuration options.

**Details:**
- Working packages: `./packages/workstreams`
- Update `docs/` with:
  - Notification system configuration guide
  - threads.json schema documentation
  - Fix command tmux integration docs
  - Migration guide from old tasks.json format
- Create `~/.config/agenv/notifications.json.example` with:
  - Custom sound file paths
  - Event-to-sound mapping
  - External API webhook examples
- Update CLI help text for new flags (`--silent`, `--no-tmux`)

###### Thread 02: Cleanup & Deprecation

**Summary:**
Add deprecation warnings and clean up transitional code.

**Details:**
- Working packages: `./packages/workstreams`
- Add console warning when reading sessions from tasks.json (deprecated location)
- Add `@deprecated` JSDoc annotations to old session fields in Task interface
- Clean up any temporary migration code
- Ensure all tests pass with new code paths
- Run full test suite: `bun run test`
- Run typecheck: `bun run typecheck`

---

*Last updated: 2026-01-23*

### Stage 05: Revision - Session Tracking & Notification Fixes

#### Stage Definition

Fix critical issues discovered after initial implementation:
1. **Session ID mismatch** - Store actual opencode session IDs (e.g., `ses_413402385ffe4rhZzbpafvjAUc`) instead of internal generated IDs
2. **Multiple notification sounds** - Play sound only once when first `opencode run` command completes, not when tmux pane/session closes
3. **First command detection** - Detect when the initial `opencode run` finishes (model done) vs when `opencode --session` TUI exits

#### Stage Constitution

**Inputs:**
- `packages/workstreams/src/lib/opencode.ts` - Shell command builders (lines 140-165, 256-283)
- `packages/workstreams/src/cli/multi.ts` - Thread execution and notification triggers (lines 808-896)
- `packages/workstreams/src/lib/tasks.ts` - Session ID generation (lines 340-344)
- `packages/workstreams/src/lib/threads.ts` - Thread metadata storage

**Structure:**
- Two parallel threads: session ID capture + notification timing fix
- Both require changes to the shell script structure in opencode.ts

**Outputs:**
- Opencode session IDs captured and stored in threads.json
- Single notification sound when `opencode run` completes (model finished)
- No duplicate sounds on tmux close

#### Stage Questions

- [x] How to capture opencode session ID from shell script? **Answer: Write to a temp file that workstreams polls/reads, or use tmux pipe-pane**
- [x] How to detect first command completion? **Answer: Add marker file or signal after `opencode run` exits, before `opencode --session`**
- [x] Should we still play batch_complete sound? **Answer: Yes, once when all threads' first commands complete**

#### Stage Batches

##### Batch 01: Session & Notification Fixes

###### Thread 01: Opencode Session ID Capture

**Summary:**
Modify the shell command structure to capture and report the actual opencode session ID back to workstreams for storage in threads.json.

**Details:**
- Working packages: `./packages/workstreams`
- Modify `src/lib/opencode.ts` `buildRunCommand()` and `buildRetryRunCommand()`:
  - After `opencode run` completes and session ID is looked up, write it to a known file path
  - File path pattern: `/tmp/workstream-{threadId}-session.txt`
  - Content: Just the opencode session ID (e.g., `ses_413402385ffe4rhZzbpafvjAUc`)
- Modify `src/cli/multi.ts`:
  - After detecting thread completion (first command), read the session file
  - Update threads.json with the actual opencode session ID via ThreadsStore
  - Clean up temp files after reading
- Update `src/lib/threads.ts`:
  - Add `opencodeSessionId` field to ThreadMetadata (separate from internal sessionId)
  - Update `updateThreadMetadata()` to handle opencode session storage
- Update tests to verify opencode session capture

###### Thread 02: First Command Completion Detection

**Summary:**
Detect when `opencode run` finishes (model done, awaiting user input) and trigger notification at that moment, not when the pane/session closes.

**Details:**
- Working packages: `./packages/workstreams`
- Modify `src/lib/opencode.ts` shell script structure:
  - After `opencode run` exits, write a marker file: `/tmp/workstream-{threadId}-complete.txt`
  - Marker indicates first command done, user can now interact with TUI
- Modify `src/cli/multi.ts`:
  - Add file watcher or polling loop to detect marker files
  - When marker detected for a thread, trigger `playNotification('thread_complete')`
  - Track which threads have notified to prevent duplicates
  - Only play `batch_complete` when ALL threads have marker files (first commands done)
- Remove notification triggers from the Ctrl-b X / session close handler
- Remove per-thread notification from the `child.on("close")` handler
- Update `--silent` flag to still suppress sounds
- Add cleanup of marker files when batch completes
- Update tests for new notification timing

###### Thread 03: Notification Deduplication

**Summary:**
Ensure only one notification per thread and one batch notification, regardless of how tmux session ends.

**Details:**
- Working packages: `./packages/workstreams`
- Create a notification state tracker in multi.ts:
  - `Set<string>` to track threadIds that have already played `thread_complete`
  - Boolean flag for `batch_complete` played
- Modify all notification call sites:
  - Check tracker before calling `playNotification()`
  - Add threadId to tracker after playing sound
- Remove the loop in Ctrl-b X handler that plays sound for each thread
- Ensure edge cases don't cause duplicate sounds:
  - Thread completes normally
  - User closes tmux session early
  - Thread fails/errors
- Add unit tests for notification deduplication logic

### Stage 06: Revision - Code Refactoring

#### Stage Definition

Refactor the codebase to improve readability, separate concerns, and reduce duplication. Focus on the largest and most complex files while maintaining functionality. All threads must run tests first and last to ensure no regressions.

#### Stage Constitution

**Inputs:**
- `packages/workstreams/src/cli/multi.ts` (1028 lines) - Main refactoring target
- `packages/workstreams/src/cli/approve.ts` (1089 lines) - Monolithic approval handlers
- `packages/workstreams/src/cli/fix.ts` (897 lines) - Duplicated utilities
- `packages/workstreams/src/lib/tasks.ts` (1300 lines) - Mixed responsibilities
- `packages/workstreams/tests/approval_flow.test.ts` (788 lines) - Setup duplication
- `packages/workstreams/tests/notifications.test.ts` (766 lines) - Mock repetition
- `packages/workstreams/tests/session-tracking.test.ts` (567 lines) - Legacy tests
- `packages/workstreams/tests/multi.test.ts` (498 lines) - Simulation-heavy

**Structure:**
- Batch 01: Source file refactoring (4 threads in parallel)
- Batch 02: Test file refactoring (4 threads in parallel)
- Each thread runs tests first and last

**Outputs:**
- `src/lib/cli-utils.ts` - Shared CLI argument parsing and help formatting
- `src/lib/multi-orchestrator.ts` - Tmux session orchestration extracted from multi.ts
- `src/lib/marker-polling.ts` - Completion marker file handling
- `src/cli/approve/` - Split approve.ts into modular handlers
- `tests/helpers/` - Shared test utilities and mock factories
- `tests/fixtures/` - Reusable PLAN.md and TASKS.md fixtures

#### Stage Questions

- [x] Should we split approve.ts into separate files or a subdirectory? **Answer: Subdirectory (src/cli/approve/)**
- [x] Should legacy migration tests be removed? **Answer: Keep but mark as legacy, may remove in future**
- [x] What's the target line count for multi.ts after refactoring? **Answer: ~400 lines (from 1028)**

#### Stage Batches

##### Batch 01: Source File Refactoring

All threads run `bun run test` first and last to ensure no regressions.

###### Thread 01: Multi.ts Decomposition

**Summary:**
Extract concerns from multi.ts (1028 lines) into focused modules, targeting ~400 lines remaining.

**Details:**
- Working packages: `./packages/workstreams`
- Run tests first: `bun run test` in packages/workstreams
- Create `src/lib/cli-utils.ts`:
  - Extract `parseCliArgs()` pattern as reusable utility
  - Extract help text formatting helpers
  - Move common CLI types (could be used by fix.ts, execute.ts, etc.)
- Create `src/lib/multi-orchestrator.ts`:
  - Extract `collectThreadInfoFromTasks()` function
  - Extract tmux session setup logic (createSession, createGridLayout calls)
  - Extract pane command building and spawning
  - Extract session cleanup functions
- Create `src/lib/marker-polling.ts`:
  - Extract `pollMarkerFiles()` async logic
  - Extract `cleanupCompletionMarkers()` and `cleanupSessionFiles()`
  - Handle marker file paths consistently
- Move `ThreadInfo` type to `src/lib/types.ts`
- Update multi.ts to import and use extracted modules
- Run tests last: `bun run test` to verify no regressions

###### Thread 02: Approve.ts Modularization

**Summary:**
Split approve.ts (1089 lines) into a modular directory structure with separate handlers.

**Details:**
- Working packages: `./packages/workstreams`
- Run tests first: `bun run test` in packages/workstreams
- Create `src/cli/approve/` directory structure:
  - `src/cli/approve/index.ts` - Main entry point, CLI arg parsing, router
  - `src/cli/approve/plan.ts` - `handlePlanApproval()` (~200 lines)
  - `src/cli/approve/tasks.ts` - `handleTasksApproval()` and `serializeTasksMdToJson()` (~250 lines)
  - `src/cli/approve/revision.ts` - `handleRevisionApproval()` (~200 lines)
  - `src/cli/approve/utils.ts` - Shared formatting, stage validation, JSON output
- Extract `checkStageCompletion()` to `src/lib/approval.ts` for reuse
- Update imports in any files that reference approve.ts
- Run tests last: `bun run test` to verify no regressions

###### Thread 03: Fix.ts & Shared Utilities

**Summary:**
Extract duplicated utilities from fix.ts and create shared modules for prompt paths and session retrieval.

**Details:**
- Working packages: `./packages/workstreams`
- Run tests first: `bun run test` in packages/workstreams
- Create `src/lib/prompt-paths.ts`:
  - Extract `getPromptFilePath()` from fix.ts
  - Extract `getPromptFilePathFromMetadata()` from multi.ts
  - Consolidate into single `resolvePromptPath(threadId, streamPath)` function
- Update `src/lib/threads.ts`:
  - Add `getLastSessionForThread(threadId)` helper
  - Add `getOpencodeSessionId(threadId)` helper
- Refactor fix.ts:
  - Use shared `resolvePromptPath()` instead of inline logic
  - Use threads.ts helpers instead of direct file access
  - Consider extracting `executeResume()` and `executeRetry()` to `src/lib/fix-actions.ts`
- Update multi.ts to use shared `resolvePromptPath()`
- Run tests last: `bun run test` to verify no regressions

###### Thread 04: Tasks.ts Simplification

**Summary:**
Simplify tasks.ts (1300 lines) by removing thin session wrappers and consolidating grouping utilities.

**Details:**
- Working packages: `./packages/workstreams`
- Run tests first: `bun run test` in packages/workstreams
- Remove thin session delegation functions that just extract threadId:
  - Evaluate if `startTaskSession()`, `completeTaskSession()` wrappers are still needed
  - If CLI code can call threads.ts directly, remove these wrappers
  - Keep only functions that add value beyond delegation
- Consolidate task grouping utilities:
  - Merge `groupTasksByStageAndThread()` and `groupTasksByStageAndBatchAndThread()`
  - Create single `groupTasks(tasks, { byStage, byBatch, byThread })` with options
- Extract discovery logic:
  - Consider moving `discoverThreadsInBatch()` to `src/lib/task-discovery.ts`
  - This makes tasks.ts focused on CRUD operations
- Update all callers of removed/changed functions
- Run tests last: `bun run test` to verify no regressions

##### Batch 02: Test Refactoring

All threads improve test infrastructure and reduce duplication.

###### Thread 01: Test Helpers Infrastructure

**Summary:**
Create shared test utilities to reduce setup duplication across all test files.

**Details:**
- Working packages: `./packages/workstreams`
- Run tests first: `bun run test` in packages/workstreams
- Create `tests/helpers/test-workspace.ts`:
  - `createTestWorkstream()` - Creates temp directory with PLAN.md, tasks.json
  - `cleanupTestWorkstream()` - Removes temp directory
  - `withTestWorkstream(callback)` - Wrapper that handles setup/cleanup
- Create `tests/helpers/cli-runner.ts`:
  - `captureCliOutput(fn)` - Captures console.log/error during CLI execution
  - `runCliCommand(command, args)` - Runs CLI and returns output
- Create `tests/helpers/mocks.ts`:
  - `createSpawnMock()` - Factory for child process spawn mocks
  - `createChildProcessMock()` - Mock ChildProcess with events
  - `mockPlayNotification()` - Notification mock with call tracking
- Run tests last: `bun run test` to verify helpers work

###### Thread 02: Approval Flow Test Refactoring

**Summary:**
Refactor approval_flow.test.ts (788 lines) to use shared helpers and fixtures.

**Details:**
- Working packages: `./packages/workstreams`
- Run tests first: `bun run test` in packages/workstreams
- Create `tests/fixtures/plans/` directory:
  - `basic-plan.md` - Simple 2-stage plan for tests
  - `multi-batch-plan.md` - Complex plan with multiple batches
  - `revision-plan.md` - Plan with revision stage
- Refactor approval_flow.test.ts:
  - Replace inline PLAN.md strings with fixture imports
  - Use `createTestWorkstream()` from helpers
  - Use `captureCliOutput()` for console capture
  - Consolidate three `beforeEach` blocks into shared setup
- Target: Reduce from 788 to ~500 lines
- Run tests last: `bun run test` to verify no regressions

###### Thread 03: Notification Test Refactoring

**Summary:**
Refactor notifications.test.ts (766 lines) to use shared mock factories.

**Details:**
- Working packages: `./packages/workstreams`
- Run tests first: `bun run test` in packages/workstreams
- Refactor notifications.test.ts:
  - Use `createSpawnMock()` from helpers instead of inline mocks
  - Use `createChildProcessMock()` for ChildProcess mocks
  - Extract repeated mock setup to `beforeEach` blocks
  - Consolidate similar test cases where appropriate
- Target: Reduce from 766 to ~500 lines
- Run tests last: `bun run test` to verify no regressions

###### Thread 04: Multi & Session Test Cleanup

**Summary:**
Refactor multi.test.ts and session-tracking.test.ts to use shared helpers and improve organization.

**Details:**
- Working packages: `./packages/workstreams`
- Run tests first: `bun run test` in packages/workstreams
- Refactor multi.test.ts:
  - Use shared mock factories from helpers
  - Review simulation tests - convert valuable ones to integration tests
  - Remove redundant tests that don't test actual code
- Refactor session-tracking.test.ts:
  - Use `createTestWorkstream()` from helpers
  - Mark legacy migration tests with `describe.skip` or `// LEGACY:` comments
  - Share setup with threads.test.ts where possible
- Target: Reduce combined lines by ~200
- Run tests last: `bun run test` to verify no regressions
