# Plan: Github Integration

> **Stream ID:** 002-github-integration | **Created:** 2026-01-21 | **Generated by:** @agenv/workstreams@0.1.0

## Summary

Add GitHub integration to the workstream package enabling automatic issue creation per thread, branch management per workstream, and filtering via labels. Disabled by default, enabled with `work github enable`. Issues are auto-created after `work approve` when enabled.

## References

- [Approved Plan](/Users/beto/.claude/plans/dapper-squishing-lemon.md)
- [types.ts](packages/workstreams/src/lib/types.ts) - Core type definitions
- [tasks.ts](packages/workstreams/src/lib/tasks.ts) - Task management
- [approve.ts](packages/workstreams/src/cli/approve.ts) - Approval workflow

## Stages

### Stage 01: Core Infrastructure

#### Stage Definition

Set up the foundational types, configuration system, authentication, and GitHub API client.

#### Stage Constitution

**Inputs:** Existing workstream types (types.ts), repo utility functions (repo.ts)
**Structure:** Create new `src/lib/github/` directory with modular files
**Outputs:** Types, config management, auth helpers, and API client ready for use

#### Stage Questions

- [x] Use PAT auth first, OAuth later
- [x] Store config in `work/github.json`

#### Stage Batches

##### Batch 01: Types and Configuration

Foundation types and config file management.

###### Thread 01: Type Definitions

**Summary:**
Create TypeScript interfaces for GitHub integration.

**Details:**
Create `src/lib/github/types.ts` with:
- `GitHubConfig` - config stored in `work/github.json`
- `LabelConfig` - label prefix configuration
- `ThreadGitHubMeta` - issue metadata stored on tasks
- `WorkstreamGitHubMeta` - branch metadata on streams
- `GitHubAuth` - authentication token types
- `GitHubResult<T>` - result wrapper for API calls
- `DEFAULT_GITHUB_CONFIG` - default configuration values

###### Thread 02: Configuration Management

**Summary:**
Manage `work/github.json` configuration file.

**Details:**
Create `src/lib/github/config.ts` with:
- `getGitHubConfigPath(repoRoot)` - path to github.json
- `loadGitHubConfig(repoRoot)` - load and parse config
- `saveGitHubConfig(repoRoot, config)` - write config
- `isGitHubEnabled(repoRoot)` - check if enabled
- `enableGitHub(repoRoot)` - enable integration
- `disableGitHub(repoRoot)` - disable integration
- Auto-detect repository from git remote origin

##### Batch 02: Authentication and Client

Authentication and API wrapper.

###### Thread 01: Authentication

**Summary:**
Handle GitHub PAT authentication with multiple sources.

**Details:**
Create `src/lib/github/auth.ts` with:
- `getGitHubAuth()` - get auth from available sources
- `getAuthFromEnv()` - check GITHUB_TOKEN, GH_TOKEN
- `getAuthFromGhCli()` - run `gh auth token` as fallback
- `validateAuth(auth)` - test token validity via API
- Priority: GITHUB_TOKEN > GH_TOKEN > gh CLI

###### Thread 02: GitHub API Client

**Summary:**
Create wrapper for GitHub REST API.

**Details:**
Create `src/lib/github/client.ts` with:
- `GitHubClient` class constructor(auth, repository)
- `createIssue(title, body, labels)` - POST /repos/{owner}/{repo}/issues
- `updateIssue(number, updates)` - PATCH /repos/{owner}/{repo}/issues/{number}
- `closeIssue(number)` - close via updateIssue
- `getIssue(number)` - GET /repos/{owner}/{repo}/issues/{number}
- `createLabel(name, color, description)` - POST /repos/{owner}/{repo}/labels
- `ensureLabels(labels)` - create labels if missing
- `createBranch(name, fromRef)` - create via refs API
- `getBranch(name)` - GET /repos/{owner}/{repo}/branches/{branch}
- Error handling, rate limit awareness

### Stage 02: Issue Management

#### Stage Definition

Implement issue creation, label management, and metadata storage.

#### Stage Constitution

**Inputs:** GitHubClient from Stage 01, thread definitions from tasks.json
**Structure:** Issue/label functions + metadata extensions to Task/StreamMetadata
**Outputs:** Ability to create issues for threads with proper labels

#### Stage Questions

- [x] One issue per thread (not per batch/stage)
- [x] Use labels for filtering, not milestones

#### Stage Batches

##### Batch 01: Issue Operations

Issue creation and label management.

###### Thread 01: Issue Creation

**Summary:**
Create GitHub issues for workstream threads.

**Details:**
Create `src/lib/github/issues.ts` with:
- `formatIssueTitle(stageId, batchId, threadId, threadName, streamName)`
  - Format: `[01.01.02] Thread Name - workstream-name`
- `formatIssueBody(input: CreateThreadIssueInput)`
  - Include summary, details, links to related threads
- `createThreadIssue(repoRoot, input)` - create issue via client
- `closeThreadIssue(repoRoot, streamId, issueNumber)` - close issue
- `storeThreadIssueMeta(repoRoot, streamId, taskId, meta)` - save to tasks.json

###### Thread 02: Label Management

**Summary:**
Manage GitHub labels for workstream filtering.

**Details:**
Create `src/lib/github/labels.ts` with:
- `getThreadLabels(config, streamName, stageId, stageName, batchId, batchName)`
  - Returns: `["workstream:name", "stage:01-name", "batch:01.01-name"]`
- `formatLabel(prefix, value)` - format label name
- `ensureWorkstreamLabels(repoRoot, streamId)` - create all labels
- Label colors: workstream=purple, stage=blue, batch=green

##### Batch 02: Metadata Storage

Extend existing types to store GitHub metadata.

###### Thread 01: Task Metadata Extension

**Summary:**
Add github_issue field to Task interface.

**Details:**
Modify `src/lib/types.ts`:
```typescript
interface Task {
  // ... existing fields ...
  github_issue?: {
    number: number
    url: string
    state: "open" | "closed"
  }
}
```
Update `src/lib/tasks.ts`:
- Handle github_issue field in read/write operations
- Add `getTaskGitHubMeta(repoRoot, streamId, taskId)`
- Add `setTaskGitHubMeta(repoRoot, streamId, taskId, meta)`

###### Thread 02: Stream Metadata Extension

**Summary:**
Add github field to StreamMetadata interface.

**Details:**
Modify `src/lib/types.ts`:
```typescript
interface StreamMetadata {
  // ... existing fields ...
  github?: {
    branch?: string
  }
}
```
Update `src/lib/index.ts`:
- Handle github field in stream operations
- Add `setStreamGitHubMeta(repoRoot, streamId, meta)`

### Stage 03: Branch Management

#### Stage Definition

Implement branch creation for workstreams with local checkout.

#### Stage Constitution

**Inputs:** GitHubClient, git CLI
**Structure:** Branch functions that create remote + checkout local
**Outputs:** Branches created in format `workstream/{id}`

#### Stage Questions

- [x] Create remote + checkout locally

#### Stage Batches

##### Batch 01: Branch Operations

Branch creation and checkout.

###### Thread 01: Branch Creation and Checkout

**Summary:**
Create workstream branch on GitHub and checkout locally.

**Details:**
Create `src/lib/github/branches.ts` with:
- `formatBranchName(config, streamId)` - e.g., `workstream/002-github-integration`
- `createWorkstreamBranch(repoRoot, streamId, fromRef?)`
  - Get default branch SHA via API
  - Create ref via POST /repos/{owner}/{repo}/git/refs
  - Run `git fetch origin` then `git checkout {branch}`
- `workstreamBranchExists(repoRoot, streamId)` - check if exists
- `storeWorkstreamBranchMeta(repoRoot, streamId, branchName)` - save to index.json
- Use `child_process.execSync` for git commands

### Stage 04: CLI Commands

#### Stage Definition

Add `work github` subcommand with enable, disable, status, create-branch, create-issues, sync.

#### Stage Constitution

**Inputs:** All github/ lib functions from previous stages
**Structure:** New CLI file + modifications to existing approve.ts and update.ts
**Outputs:** Full CLI interface for GitHub integration

#### Stage Questions

- [x] Command: `work github <subcommand>`

#### Stage Batches

##### Batch 01: Core Commands

Main CLI entry point and basic commands.

###### Thread 01: GitHub CLI Entry Point

**Summary:**
Create main `work github` command router.

**Details:**
Create `src/cli/github.ts` with:
- Subcommand router for: enable, disable, status, create-branch, create-issues, sync
- `enable` - enable GitHub integration, auto-detect repo
- `disable` - disable integration
- `status` - show config, auth status, repository

Update `bin/work.ts`:
- Add `github` to command switch statement
- Import and route to github.ts

###### Thread 02: Issue Commands

**Summary:**
Add create-issues subcommand.

**Details:**
In `src/cli/github.ts`:
- `create-issues --batch "01.01"` - create issues for batch threads
- `create-issues --stage 1` - create issues for all threads in stage
- `create-issues` (no args) - create issues for all pending threads
- Show created issue URLs in output

###### Thread 03: Branch Commands

**Summary:**
Add create-branch subcommand.

**Details:**
In `src/cli/github.ts`:
- `create-branch` - create branch for current workstream
- `create-branch --stream "002-github-integration"` - specify stream
- `create-branch --from main` - specify base branch (default: main)
- After creation, checkout locally and show branch name

##### Batch 02: Automation Hooks

Integrate with existing approve and update commands.

###### Thread 01: Approve Hook

**Summary:**
Auto-create issues after workstream approval.

**Details:**
Modify `src/cli/approve.ts`:
- After successful approval, check if GitHub is enabled
- If enabled and auto_create_issues is true:
  - Call `ensureWorkstreamLabels()` to create labels
  - Call `createThreadIssue()` for each thread
  - Log created issue URLs
- Handle errors gracefully (don't fail approval if GitHub fails)

###### Thread 02: Update Hook

**Summary:**
Auto-close issue when thread completes.

**Details:**
Modify `src/cli/update.ts`:
- After task status changes to "completed":
  - Check if all tasks in same thread are completed
  - If thread complete and has github_issue, close the issue
  - Update github_issue.state to "closed" in tasks.json

Create `src/lib/github/sync.ts`:
- `isThreadComplete(repoRoot, streamId, stageId, batchId, threadId)`
- `checkAndCloseThreadIssue(repoRoot, streamId, taskId)`

###### Thread 03: Sync Command

**Summary:**
Manual sync command for issue states.

**Details:**
In `src/cli/github.ts`:
- `sync` - sync all issue states for current workstream
- `sync --stream "002-..."` - specify stream
- Close issues for completed threads, log changes
- Report: "Closed N issues, M unchanged"

### Stage 05: Integration and Polish

#### Stage Definition

Integrate with init, multi commands and add documentation.

#### Stage Constitution

**Inputs:** Complete GitHub integration from previous stages
**Structure:** Touch points in existing commands + README
**Outputs:** Seamless integration and documented feature

#### Stage Questions

- [x] Add to init for default config

#### Stage Batches

##### Batch 01: Integration Points

Integrate with existing commands.

###### Thread 01: Init Integration

**Summary:**
Create default github.json during `work init`.

**Details:**
Modify `src/cli/init.ts`:
- After creating work/ directory, create `github.json`
- Use DEFAULT_GITHUB_CONFIG with enabled: false
- Log: "Created github.json (disabled by default)"

###### Thread 02: Multi Integration

**Summary:**
Show issue URLs in `work multi` output.

**Details:**
Modify `src/cli/multi.ts`:
- When displaying thread info, check for github_issue
- If present, show: `Issue: https://github.com/owner/repo/issues/N`
- In tmux pane title, include issue number if available

##### Batch 02: Documentation

Update README with GitHub integration docs.

###### Thread 01: README Update

**Summary:**
Document GitHub integration feature.

**Details:**
Update `packages/workstreams/README.md`:
- Add "GitHub Integration" section
- Document setup: PAT, environment variable
- Document commands: `work github enable|disable|status|create-branch|create-issues|sync`
- Document automation: auto-create after approve, auto-close on completion
- Document label convention and filtering

---

*Last updated: 2026-01-21*

### Stage 06: Issue Lifecycle and Workstream Completion

#### Stage Definition

Fix issue body updates on completion, connect labels to issues, add issue reopening on status change, and implement workstream completion command with PR creation.

#### Stage Constitution

**Inputs:** Existing GitHub integration from Stages 01-05, git CLI, `work complete` placeholder
**Structure:** Two batches - issue lifecycle fixes and completion workflow
**Outputs:** Complete issue lifecycle (create → update → close → reopen) and streamlined PR workflow

#### Stage Questions

- [x] Update issue body at thread completion (not per-task)
- [x] Include task reports in updated issue body
- [x] Check all stages approved before completing workstream

#### Stage Batches

##### Batch 01: Issue Lifecycle

Fix issue lifecycle: body updates, labels, and reopening.

###### Thread 01: Update Issue Body on Completion

**Summary:**
Update GitHub issue body when thread completes to show checked tasks with reports.

**Details:**
Modify `src/lib/github/issues.ts`:
- Add `formatCompletedIssueBody(input, tasks[])` function
  - Format tasks as `- [x] Task name` (checked)
  - Include report as blockquote if present: `> Report: ...`
  - Mark cancelled tasks with `*(cancelled)*`
- Add `updateThreadIssueBody(repoRoot, streamId, issueNumber, tasks[])` function
  - Use `client.updateIssue()` with new body

Modify `src/lib/github/sync.ts`:
- In `checkAndCloseThreadIssue()`: call `updateThreadIssueBody()` before closing
- In `syncIssueStates()`: call `updateThreadIssueBody()` before closing

###### Thread 02: Apply Labels to Issues

**Summary:**
Connect label creation to issue creation - labels are created but not attached.

**Details:**
Review `src/lib/github/issues.ts`:
- Line 76 has `const labels: string[] = []` with TODO
- Call `getThreadLabels()` from labels.ts to get label names
- Pass labels array to `client.createIssue()`

Verify in `src/lib/github/labels.ts`:
- Ensure `getThreadLabels()` returns correct label names
- Labels should already exist via `ensureWorkstreamLabels()`

###### Thread 03: Reopen Issues on Status Change

**Summary:**
Reopen GitHub issue when task status changes from completed back to in_progress or blocked.

**Details:**
Modify `src/lib/github/sync.ts`:
- Add `reopenThreadIssue(repoRoot, streamId, issueNumber)` function
- Add `checkAndReopenThreadIssue(repoRoot, streamId, taskId)` function
  - Called when task changes FROM completed TO in_progress/blocked
  - Check if thread was complete, now incomplete
  - Reopen issue if github_issue.state is "closed"

Modify `src/cli/update.ts`:
- After task status change, if previous status was "completed":
  - Call `checkAndReopenThreadIssue()`
- Track previous status before update

Add to `src/lib/github/client.ts`:
- Add `reopenIssue(number)` method (use updateIssue with state: "open")

##### Batch 02: Workstream Completion

Implement `work complete` command for PR workflow.

###### Thread 01: Complete Command Foundation

**Summary:**
Create `work complete` command that validates and prepares for PR.

**Details:**
Create `src/cli/complete.ts`:
- Check all stages are approved (`work check approval` logic)
- Check GitHub is enabled and branch exists
- Verify we're on the workstream branch
- Display summary: tasks completed, branch name, target branch
- Store completion metadata in stream (index.json):
  ```typescript
  github?: {
    branch?: string
    completed_at?: string
    pr_number?: number
  }
  ```

Update `bin/work.ts`:
- Add `complete` to command router

###### Thread 02: Git Operations

**Summary:**
Auto-add, commit, and push changes on completion.

**Details:**
In `src/cli/complete.ts`:
- Add `--commit` flag (default: true, use `--no-commit` to skip)
- Run `git add -A` to stage all changes
- Run `git commit -m "Completed workstream: {stream-name}"`
  - Include stream ID and summary in commit body
- Run `git push origin {branch-name}`
- Handle already-pushed case gracefully
- Show pushed commit SHA

###### Thread 03: PR Creation

**Summary:**
Create pull request to target branch with configurable defaults.

**Details:**
In `src/cli/complete.ts`:
- Add `--pr` flag (default: true, use `--no-pr` to skip)
- Add `--target <branch>` option for PR target (default from config or "main")
- Add `--draft` flag for draft PR

In `src/lib/github/config.ts`:
- Add `default_pr_target?: string` to GitHubConfig

PR creation:
- Use GitHub API POST /repos/{owner}/{repo}/pulls
- Title: `[{stream-id}] {stream-name}`
- Body: Include summary, link to PLAN.md, task counts
- If no `--target` and no config default, prompt user to select

In `src/lib/github/client.ts`:
- Add `createPullRequest(title, body, head, base, draft?)` method

Output:
- Show PR URL
- Store PR number in stream metadata
