# Plan: Web Visualization

> **Stream ID:** 000-web-visualization | **Created:** 2026-01-20 | **Generated by:** @agenv/workstreams@0.1.0

## Summary

Add a web-based visualization interface to `@agenv/workstreams` using Bun's native HTTP server with HTMX for interactivity and PicoCSS for styling. The interface is read-only, providing a dashboard to view workstream progress, task hierarchies, and metrics.

## References

- Claude plan: `~/.claude/plans/joyful-inventing-kitten.md`
- Package: `packages/workstreams/`
- Key libs: `src/lib/index.ts`, `src/lib/tasks.ts`, `src/lib/status.ts`, `src/lib/stream-parser.ts`

## Stages

### Stage 01: Foundation

#### Stage Definition

Set up the core web server infrastructure: HTTP server, routing, CLI command, and base HTML layout with PicoCSS and HTMX.

#### Stage Constitution

**Inputs:**

- Existing `bin/work.ts` CLI structure
- Bun's native `Bun.serve()` API

**Structure:**

- `src/web/server.ts` - Main server with Bun.serve()
- `src/web/router.ts` - URL pattern matching
- `src/cli/serve.ts` - CLI command handler
- `src/web/utils/html.ts` - Template utilities
- `src/web/components/layout.ts` - Base HTML document

**Outputs:**

- Running `work serve` starts a web server on port 3000
- Visiting http://localhost:3000 shows a basic page with PicoCSS styling

#### Stage Questions

- [x] Use Bun native server vs Express/Hono? (Decided: Bun native)
- [x] Template engine? (Decided: Tagged template literals)

#### Stage Batches

##### Batch 01: Server Infrastructure

Set up server, routing, and CLI integration.

###### Thread 01: Server and Router

**Summary:**
Create Bun HTTP server with URL pattern matching router.

**Details:**
- Create `src/web/server.ts` with `Bun.serve()` setup
- Create `src/web/router.ts` with regex-based URL pattern matching
- Support route parameters like `/stream/:id`
- Return 404 for unmatched routes

###### Thread 02: CLI Command

**Summary:**
Add `work serve` command to start the web server.

**Details:**
- Create `src/cli/serve.ts` with options: `--port`, `--host`, `--open`
- Add `serve` to `bin/work.ts` SUBCOMMANDS
- Default port 3000, host localhost

##### Batch 02: HTML Foundation

Set up base templates and utilities.

###### Thread 01: Template Utilities

**Summary:**
Create HTML template tag and escape function.

**Details:**
- Create `src/web/utils/html.ts`
- Implement `html` tagged template literal
- Implement `escapeHtml()` for XSS prevention

###### Thread 02: Base Layout

**Summary:**
Create base HTML layout with PicoCSS and HTMX CDN links.

**Details:**
- Create `src/web/components/layout.ts`
- Include PicoCSS from CDN
- Include HTMX from CDN
- Support `<slot>` pattern for page content

### Stage 02: Dashboard

#### Stage Definition

Implement the main dashboard view showing all workstreams with progress indicators.

#### Stage Constitution

**Inputs:**

- Working server from Stage 01
- `loadIndex()` function from `src/lib/index.ts`
- `getStreamProgress()` from `src/lib/status.ts`

**Structure:**

- `src/web/handlers/dashboard.ts` - Dashboard page handler
- `src/web/components/progress-bar.ts` - Progress visualization
- `src/web/components/status-badge.ts` - Status indicators
- `src/web/utils/data.ts` - Data fetching wrappers
- `src/web/handlers/fragments/progress.ts` - HTMX polling fragment

**Outputs:**

- Dashboard at `/` lists all workstreams
- Each workstream shows progress bar and status
- Progress bars auto-update via HTMX polling (5s)

#### Stage Questions

- [x] Polling interval? (Decided: 5 seconds)

#### Stage Batches

##### Batch 01: Data and Components

Create data utilities and reusable components.

###### Thread 01: Data Utilities

**Summary:**
Create wrapper functions around existing lib functions for web use.

**Details:**
- Create `src/web/utils/data.ts`
- `getDashboardData(repoRoot)` - Get all streams with progress
- `getStreamData(repoRoot, streamId)` - Get single stream details

###### Thread 02: Progress Components

**Summary:**
Create progress bar and status badge components.

**Details:**
- Create `src/web/components/progress-bar.ts`
- Create `src/web/components/status-badge.ts`
- Use PicoCSS `<progress>` element
- Color-code by status: pending (gray), in_progress (blue), completed (green), blocked (red)

##### Batch 02: Dashboard Handler

Create the dashboard page and polling fragment.

###### Thread 01: Dashboard Page

**Summary:**
Create the main dashboard handler.

**Details:**
- Create `src/web/handlers/dashboard.ts`
- List all workstreams from index
- Show name, status badge, progress bar for each
- Link to detail view `/stream/:id`

###### Thread 02: Progress Fragment

**Summary:**
Create HTMX fragment for progress bar polling.

**Details:**
- Create `src/web/handlers/fragments/progress.ts`
- Endpoint: `GET /fragment/progress/:id`
- Returns just the progress bar HTML
- Include `hx-trigger="every 5s"` for auto-refresh

### Stage 03: Workstream Detail

#### Stage Definition

Implement the workstream detail view with hierarchical stage/batch/thread display.

#### Stage Constitution

**Inputs:**

- Dashboard from Stage 02
- `parseStreamDocument()` from `src/lib/stream-parser.ts`
- `getTasks()` from `src/lib/tasks.ts`

**Structure:**

- `src/web/handlers/stream.ts` - Stream detail page
- `src/web/components/stage-card.ts` - Stage hierarchy display
- `src/web/components/task-table.ts` - Task listing
- `src/web/handlers/fragments/stage.ts` - Lazy-load stage content
- `src/web/handlers/fragments/tasks.ts` - Task list fragment

**Outputs:**

- `/stream/:id` shows workstream detail
- Stages expand to show batches and threads
- Tasks are listed per thread with status

#### Stage Questions

- [x] Lazy load or eager load stage content? (Decided: Lazy load with HTMX)

#### Stage Batches

##### Batch 01: Detail Page

Create the main stream detail view.

###### Thread 01: Stream Handler

**Summary:**
Create the stream detail page handler.

**Details:**
- Create `src/web/handlers/stream.ts`
- Parse PLAN.md to get structure
- Show summary, stages overview
- Use `<details>` elements for expandable stages

###### Thread 02: Stage Components

**Summary:**
Create components for displaying stage hierarchy.

**Details:**
- Create `src/web/components/stage-card.ts`
- Show stage name, definition summary
- Nested batches and threads
- Progress indicator per stage

##### Batch 02: Task Display

Create task listing and lazy-load fragments.

###### Thread 01: Task Table

**Summary:**
Create task table component.

**Details:**
- Create `src/web/components/task-table.ts`
- Show task ID, name, status, timestamps
- Group by thread
- Status icons: pending, in_progress, completed, blocked

###### Thread 02: Lazy Load Fragments

**Summary:**
Create HTMX fragments for lazy loading content.

**Details:**
- Create `src/web/handlers/fragments/stage.ts` - `GET /fragment/stage/:id/:num`
- Create `src/web/handlers/fragments/tasks.ts` - `GET /fragment/tasks/:id`
- Use `hx-trigger="toggle once"` on `<details>` elements

### Stage 04: Task Detail and Metrics

#### Stage Definition

Implement individual task detail view and metrics/analytics page.

#### Stage Constitution

**Inputs:**

- Stream detail from Stage 03
- `evaluateStream()` from `src/lib/metrics.ts`
- Task data from `tasks.json`

**Structure:**

- `src/web/handlers/task.ts` - Task detail page
- `src/web/handlers/metrics.ts` - Metrics page
- `src/web/components/breadcrumb.ts` - Navigation breadcrumb

**Outputs:**

- `/task/:streamId/:taskId` shows task detail
- `/stream/:id/metrics` shows analytics
- Breadcrumb navigation on all pages

#### Stage Questions

- [x] Include charts? (Decided: Simple text/table metrics, no JS charts)

#### Stage Batches

##### Batch 01: Task Detail

Create task detail view with breadcrumb.

###### Thread 01: Task Handler

**Summary:**
Create task detail page.

**Details:**
- Create `src/web/handlers/task.ts`
- Show all task metadata: id, name, status, breadcrumb, assigned_agent
- Show parent hierarchy (stage > batch > thread)
- Show timestamps (created, updated)

###### Thread 02: Breadcrumb Component

**Summary:**
Create breadcrumb navigation component.

**Details:**
- Create `src/web/components/breadcrumb.ts`
- Format: Dashboard > Stream Name > Stage > Task
- Use HTMX `hx-push-url` for SPA-like navigation

##### Batch 02: Metrics View

Create metrics and analytics page.

###### Thread 01: Metrics Handler

**Summary:**
Create metrics page with analytics.

**Details:**
- Create `src/web/handlers/metrics.ts`
- Show task counts by status
- Show completion rate, blocked rate
- List blocked tasks with reasons
- Stage-by-stage breakdown

### Stage 05: Polish and Testing

#### Stage Definition

Add error handling, loading states, and test the implementation.

#### Stage Constitution

**Inputs:**

- Complete web interface from Stages 01-04
- Existing test infrastructure

**Structure:**

- Error handlers and 404 page
- Loading state indicators
- Manual testing checklist

**Outputs:**

- Graceful error handling
- Good UX with loading indicators
- Verified working implementation

#### Stage Questions

- [x] Add automated tests? (Decided: Manual testing first, automated later if needed)

#### Stage Batches

##### Batch 01: Error Handling

Add error handling and edge cases.

###### Thread 01: Error Pages

**Summary:**
Create 404 and error pages.

**Details:**
- Add 404 handler for unknown routes
- Add error page for internal errors
- Handle missing workstreams gracefully
- Handle empty workstream list

###### Thread 02: Loading States

**Summary:**
Add loading indicators for HTMX requests.

**Details:**
- Add `htmx:beforeRequest` / `htmx:afterRequest` handlers
- Show loading spinner during fragment fetches
- Use `hx-indicator` attribute

##### Batch 02: Testing and Documentation

Test and document the feature.

###### Thread 01: Manual Testing

**Summary:**
Test with real workstreams.

**Details:**
- Test with 0, 1, and multiple workstreams
- Test progress updates
- Test lazy loading
- Test navigation and breadcrumbs
- Verify existing tests still pass

###### Thread 02: Documentation

**Summary:**
Update README and help text.

**Details:**
- Add `work serve` to README
- Update CLI help in `bin/work.ts`
- Document available endpoints

---

*Last updated: 2026-01-20*
