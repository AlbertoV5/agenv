# Plan: Synthesis Output Parsing

> **Stream ID:** 011-synthesis-output-parsing | **Created:** 2026-01-24 | **Generated by:** @agenv/workstreams@0.1.0

## Summary

Fix the synthesis agent output parsing in the workstreams CLI. Currently, synthesis agent output is lost because the shell script uses `jq` to parse JSONL output with incorrect format assumptions. The fix moves JSONL parsing to TypeScript/Bun for type-safe, debuggable extraction with proper logging.

**Problem:** `opencode run --format json` outputs JSONL (one JSON object per line), but the current shell script assumes a single JSON object with a `messages` array. This causes silent failures and empty synthesis output.

**Solution:** 
1. Create a new `synthesis/output.ts` module to parse JSONL in TypeScript
2. Simplify the shell script to just write raw JSONL (no jq parsing)
3. Update consumers (`multi.ts`, `marker-polling.ts`) to use the new parser
4. Add debug logging for troubleshooting

## References

- `packages/workstreams/src/lib/synthesis/` - Existing synthesis module
- `packages/workstreams/src/lib/opencode.ts` - Shell command builders
- `packages/workstreams/src/cli/multi.ts` - Main CLI that reads synthesis output
- `packages/workstreams/src/lib/marker-polling.ts` - Notification polling that reads synthesis output
- `/tmp/workstream-*-synthesis.json` - Example JSONL output files

## Stages

### Stage 01: Core Implementation

#### Stage Definition

Implement the TypeScript JSONL parser and integrate it with the existing codebase. This includes creating the new module, updating the shell commands, and modifying the consumers.

#### Stage Constitution

**Inputs:**
- Existing synthesis module structure in `packages/workstreams/src/lib/synthesis/`
- JSONL format specification from `opencode run --format json` output
- Current shell script in `packages/workstreams/src/lib/opencode.ts:buildPostSynthesisCommand()`

**Structure:**
- Batch 1: Create parser module and update shell commands (can be done in parallel)
- Batch 2: Update consumers to use new parser (depends on Batch 1)

**Outputs:**
- New `synthesis/output.ts` module with JSONL parsing functions
- Simplified shell script without jq parsing
- Updated `multi.ts` and `marker-polling.ts` using the new parser
- Debug logs written to `/tmp/workstream-*-synthesis.log`

#### Stage Questions

- [x] Should we use jq in shell or parse in TypeScript? **Decision: TypeScript for type safety and better error handling**
- [x] Where to store debug logs? **Decision: `/tmp/workstream-{streamId}-{threadId}-synthesis.log`**

#### Stage Batches

##### Batch 01: Parser and Shell Updates

Create the JSONL parser module and simplify the shell command generation. These can run in parallel since they don't have direct code dependencies.

###### Thread 01: Create JSONL Parser Module

**Summary:**
Create the new `synthesis/output.ts` module that parses JSONL output from `opencode run --format json`.

**Details:**
- Working package: `./packages/workstreams`
- Create `packages/workstreams/src/lib/synthesis/output.ts` with:
  - Type definitions for JSONL events (`JsonlTextEvent`, `JsonlStepEvent`, etc.)
  - `parseSynthesisJsonl(content: string): SynthesisParseResult` - Parse JSONL string
  - `parseSynthesisOutputFile(filePath: string, logPath?: string): SynthesisParseResult` - Read and parse file with logging
  - `SynthesisParseResult` interface with `text`, `logs`, and `success` fields
- Update `packages/workstreams/src/lib/synthesis/index.ts` to export new functions
- JSONL format to parse:
  ```jsonl
  {"type":"step_start",...}
  {"type":"text","part":{"text":"THE_SYNTHESIS_OUTPUT"}}
  {"type":"step_finish",...}
  ```
- Extract all `type: "text"` events and concatenate their `.part.text` values

###### Thread 02: Simplify Shell Commands

**Summary:**
Update `opencode.ts` to remove jq-based parsing and add path helper functions for the new file structure.

**Details:**
- Working package: `./packages/workstreams`
- Modify `packages/workstreams/src/lib/opencode.ts`:
  - Add `getSynthesisLogPath(streamId, threadId)` function returning `/tmp/workstream-{streamId}-{threadId}-synthesis.log`
  - Update `buildPostSynthesisCommand()` to:
    - Remove the jq extraction code (lines ~862-868)
    - Remove the `.txt` output file (no longer needed)
    - Keep the `.json` file as the raw JSONL output
    - Add simple logging: echo timestamp and file size to log path
  - The completion marker should still be written after synthesis finishes
- The `.json` file will now contain raw JSONL that TypeScript parses

##### Batch 02: Consumer Updates

Update the TypeScript code that consumes synthesis output to use the new parser.

###### Thread 01: Update multi.ts

**Summary:**
Update `handleSessionClose()` in `multi.ts` to use the new JSONL parser instead of reading the `.txt` file directly.

**Details:**
- Working package: `./packages/workstreams`
- Modify `packages/workstreams/src/cli/multi.ts`:
  - Import `parseSynthesisOutputFile` from `../lib/synthesis/output.ts`
  - Import `getSynthesisLogPath` from `../lib/opencode.ts`
  - In `handleSessionClose()` (around line 450-464):
    - Replace `getSynthesisOutputPath` with reading the `.json` file (JSONL)
    - Call `parseSynthesisOutputFile(jsonPath, logPath)` to parse
    - Use `parseResult.text` as the synthesis output
    - Log warning if `parseResult.success` is false
  - Update cleanup to handle new file paths

###### Thread 02: Update marker-polling.ts

**Summary:**
Update `pollMarkerFiles()` in `marker-polling.ts` to use the new JSONL parser for reading synthesis output.

**Details:**
- Working package: `./packages/workstreams`
- Modify `packages/workstreams/src/lib/marker-polling.ts`:
  - Import `parseSynthesisOutputFile` from `./synthesis/output.ts`
  - Import `getSynthesisLogPath` from `./opencode.ts`
  - In `pollMarkerFiles()` (around line 135-146):
    - Change from reading `.txt` file to parsing `.json` file
    - Use `parseSynthesisOutputFile()` to get synthesis text
  - In `cleanupSynthesisFiles()`:
    - Add cleanup for `.log` files
    - Update to clean up `.json` files instead of `.txt` files
  - Add `getSynthesisJsonPath` helper or use the existing path with `.json` extension

### Stage 02: Testing and Validation

#### Stage Definition

Validate the implementation works correctly with real workstream execution and verify the logging provides useful debug information.

#### Stage Constitution

**Inputs:**
- Completed implementation from Stage 01
- Existing test infrastructure in `packages/workstreams/tests/`
- Real workstream in `~/betalytics-backend` for manual testing

**Structure:**
- Single batch with unit tests and integration verification

**Outputs:**
- Unit tests for the JSONL parser
- Verified working synthesis output in a real workstream

#### Stage Questions

- [x] Do we need unit tests? **Decision: Yes, for the parser module**

#### Stage Batches

##### Batch 01: Tests

###### Thread 01: Parser Unit Tests

**Summary:**
Create unit tests for the JSONL parser to ensure correct extraction of text content.

**Details:**
- Working package: `./packages/workstreams`
- Create `packages/workstreams/tests/synthesis-output.test.ts` with:
  - Test parsing valid JSONL with text events
  - Test parsing JSONL with no text events (returns empty string)
  - Test parsing JSONL with multiple text events (concatenates)
  - Test handling malformed lines (skips bad lines, logs warning)
  - Test file not found handling
  - Test empty file handling
- Run with `bun test` in the workstreams package

---

*Last updated: 2026-01-24*
