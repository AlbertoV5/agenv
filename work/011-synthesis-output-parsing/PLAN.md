# Plan: Synthesis Output Parsing

> **Stream ID:** 011-synthesis-output-parsing | **Created:** 2026-01-24 | **Generated by:** @agenv/workstreams@0.1.0

## Summary

Fix the synthesis agent output parsing in the workstreams CLI. Currently, synthesis agent output is lost because the shell script uses `jq` to parse JSONL output with incorrect format assumptions. The fix moves JSONL parsing to TypeScript/Bun for type-safe, debuggable extraction with proper logging.

**Problem:** `opencode run --format json` outputs JSONL (one JSON object per line), but the current shell script assumes a single JSON object with a `messages` array. This causes silent failures and empty synthesis output.

**Solution:** 
1. Create a new `synthesis/output.ts` module to parse JSONL in TypeScript
2. Simplify the shell script to just write raw JSONL (no jq parsing)
3. Update consumers (`multi.ts`, `marker-polling.ts`) to use the new parser
4. Add debug logging for troubleshooting

## References

- `packages/workstreams/src/lib/synthesis/` - Existing synthesis module
- `packages/workstreams/src/lib/opencode.ts` - Shell command builders
- `packages/workstreams/src/cli/multi.ts` - Main CLI that reads synthesis output
- `packages/workstreams/src/lib/marker-polling.ts` - Notification polling that reads synthesis output
- `/tmp/workstream-*-synthesis.json` - Example JSONL output files

## Stages

### Stage 01: Core Implementation

#### Stage Definition

Implement the TypeScript JSONL parser and integrate it with the existing codebase. This includes creating the new module, updating the shell commands, and modifying the consumers.

#### Stage Constitution

**Inputs:**
- Existing synthesis module structure in `packages/workstreams/src/lib/synthesis/`
- JSONL format specification from `opencode run --format json` output
- Current shell script in `packages/workstreams/src/lib/opencode.ts:buildPostSynthesisCommand()`

**Structure:**
- Batch 1: Create parser module and update shell commands (can be done in parallel)
- Batch 2: Update consumers to use new parser (depends on Batch 1)

**Outputs:**
- New `synthesis/output.ts` module with JSONL parsing functions
- Simplified shell script without jq parsing
- Updated `multi.ts` and `marker-polling.ts` using the new parser
- Debug logs written to `/tmp/workstream-*-synthesis.log`

#### Stage Questions

- [x] Should we use jq in shell or parse in TypeScript? **Decision: TypeScript for type safety and better error handling**
- [x] Where to store debug logs? **Decision: `/tmp/workstream-{streamId}-{threadId}-synthesis.log`**

#### Stage Batches

##### Batch 01: Parser and Shell Updates

Create the JSONL parser module and simplify the shell command generation. These can run in parallel since they don't have direct code dependencies.

###### Thread 01: Create JSONL Parser Module

**Summary:**
Create the new `synthesis/output.ts` module that parses JSONL output from `opencode run --format json`.

**Details:**
- Working package: `./packages/workstreams`
- Create `packages/workstreams/src/lib/synthesis/output.ts` with:
  - Type definitions for JSONL events (`JsonlTextEvent`, `JsonlStepEvent`, etc.)
  - `parseSynthesisJsonl(content: string): SynthesisParseResult` - Parse JSONL string
  - `parseSynthesisOutputFile(filePath: string, logPath?: string): SynthesisParseResult` - Read and parse file with logging
  - `SynthesisParseResult` interface with `text`, `logs`, and `success` fields
- Update `packages/workstreams/src/lib/synthesis/index.ts` to export new functions
- JSONL format to parse:
  ```jsonl
  {"type":"step_start",...}
  {"type":"text","part":{"text":"THE_SYNTHESIS_OUTPUT"}}
  {"type":"step_finish",...}
  ```
- Extract all `type: "text"` events and concatenate their `.part.text` values

###### Thread 02: Simplify Shell Commands

**Summary:**
Update `opencode.ts` to remove jq-based parsing and add path helper functions for the new file structure.

**Details:**
- Working package: `./packages/workstreams`
- Modify `packages/workstreams/src/lib/opencode.ts`:
  - Add `getSynthesisLogPath(streamId, threadId)` function returning `/tmp/workstream-{streamId}-{threadId}-synthesis.log`
  - Update `buildPostSynthesisCommand()` to:
    - Remove the jq extraction code (lines ~862-868)
    - Remove the `.txt` output file (no longer needed)
    - Keep the `.json` file as the raw JSONL output
    - Add simple logging: echo timestamp and file size to log path
  - The completion marker should still be written after synthesis finishes
- The `.json` file will now contain raw JSONL that TypeScript parses

##### Batch 02: Consumer Updates

Update the TypeScript code that consumes synthesis output to use the new parser.

###### Thread 01: Update multi.ts

**Summary:**
Update `handleSessionClose()` in `multi.ts` to use the new JSONL parser instead of reading the `.txt` file directly.

**Details:**
- Working package: `./packages/workstreams`
- Modify `packages/workstreams/src/cli/multi.ts`:
  - Import `parseSynthesisOutputFile` from `../lib/synthesis/output.ts`
  - Import `getSynthesisLogPath` from `../lib/opencode.ts`
  - In `handleSessionClose()` (around line 450-464):
    - Replace `getSynthesisOutputPath` with reading the `.json` file (JSONL)
    - Call `parseSynthesisOutputFile(jsonPath, logPath)` to parse
    - Use `parseResult.text` as the synthesis output
    - Log warning if `parseResult.success` is false
  - Update cleanup to handle new file paths

###### Thread 02: Update marker-polling.ts

**Summary:**
Update `pollMarkerFiles()` in `marker-polling.ts` to use the new JSONL parser for reading synthesis output.

**Details:**
- Working package: `./packages/workstreams`
- Modify `packages/workstreams/src/lib/marker-polling.ts`:
  - Import `parseSynthesisOutputFile` from `./synthesis/output.ts`
  - Import `getSynthesisLogPath` from `./opencode.ts`
  - In `pollMarkerFiles()` (around line 135-146):
    - Change from reading `.txt` file to parsing `.json` file
    - Use `parseSynthesisOutputFile()` to get synthesis text
  - In `cleanupSynthesisFiles()`:
    - Add cleanup for `.log` files
    - Update to clean up `.json` files instead of `.txt` files
  - Add `getSynthesisJsonPath` helper or use the existing path with `.json` extension

### Stage 02: Testing and Validation

#### Stage Definition

Validate the implementation works correctly with real workstream execution and verify the logging provides useful debug information.

#### Stage Constitution

**Inputs:**
- Completed implementation from Stage 01
- Existing test infrastructure in `packages/workstreams/tests/`
- Real workstream in `~/betalytics-backend` for manual testing

**Structure:**
- Single batch with unit tests and integration verification

**Outputs:**
- Unit tests for the JSONL parser
- Verified working synthesis output in a real workstream

#### Stage Questions

- [x] Do we need unit tests? **Decision: Yes, for the parser module**

#### Stage Batches

##### Batch 01: Tests

###### Thread 01: Parser Unit Tests

**Summary:**
Create unit tests for the JSONL parser to ensure correct extraction of text content.

**Details:**
- Working package: `./packages/workstreams`
- Create `packages/workstreams/tests/synthesis-output.test.ts` with:
  - Test parsing valid JSONL with text events
  - Test parsing JSONL with no text events (returns empty string)
  - Test parsing JSONL with multiple text events (concatenates)
  - Test handling malformed lines (skips bad lines, logs warning)
  - Test file not found handling
  - Test empty file handling
- Run with `bun test` in the workstreams package

---

*Last updated: 2026-01-24*

### Stage 03: Revision - Planning Session Resume

#### Stage Definition

Implement `work plan` command that resumes the opencode session used during workstream planning. This allows users to continue conversations with the planning agent after initial workstream creation.

#### Stage Constitution

**Inputs:**
- Existing session tracking patterns in `packages/workstreams/src/lib/threads.ts` and `packages/workstreams/src/lib/index.ts`
- Opencode session management via `opencode --session <id>`
- Current `work create` implementation in `packages/workstreams/src/cli/create.ts`

**Structure:**
- Batch 1: Add session storage to types and index (parallel threads)
- Batch 2: Create the `work plan` CLI command

**Outputs:**
- `planningSession` field in `StreamMetadata` type
- Helper functions to get/set planning session ID
- New `work plan` CLI command that resumes the planning session

#### Stage Questions

- [x] Where to store the planning session ID? **Decision: In index.json as part of StreamMetadata**
- [x] How to capture the session ID after `work create`? **Decision: Use tracking ID in title, find session via `opencode session list`**

#### Stage Batches

##### Batch 01: Session Storage Infrastructure

Add the types and helper functions needed to store and retrieve planning session IDs.

###### Thread 01: Add Types and Index Helpers

**Summary:**
Add `planningSession` field to `StreamMetadata` type and create helper functions in `index.ts` to get/set planning session IDs.

**Details:**
- Working package: `./packages/workstreams`
- Update `packages/workstreams/src/lib/types.ts`:
  - Add `PlanningSession` interface with `sessionId: string` and `createdAt: string`
  - Add optional `planningSession?: PlanningSession` field to `StreamMetadata`
- Update `packages/workstreams/src/lib/index.ts`:
  - Add `setStreamPlanningSession(repoRoot, streamId, sessionId)` function
  - Add `getPlanningSessionId(repoRoot, streamId): string | null` function
  - Follow existing pattern from `setStreamGitHubMeta()`

##### Batch 02: CLI Command

Create the `work plan` command that resumes the planning session.

###### Thread 01: Create work plan CLI

**Summary:**
Create the `work plan` CLI command that opens the planning opencode session for the current workstream.

**Details:**
- Working package: `./packages/workstreams`
- Create `packages/workstreams/src/cli/plan.ts`:
  - Parse CLI args: `--stream` (optional, uses current), `--help`
  - Get current workstream if not specified
  - Look up planning session ID from index
  - If session exists: run `opencode --session <id>`
  - If no session: print helpful message about running `work create` first or offer to start a new planning session
- Update `packages/workstreams/src/bin/work.ts` to add the `plan` subcommand
- The command should:
  - Support `work plan` (uses current workstream)
  - Support `work plan --stream "001-my-stream"` (explicit workstream)
  - Print the session ID being resumed for user reference

###### Thread 02: Update work create to capture session

**Summary:**
Update `work create` to capture the opencode session ID after the planning agent completes, so it can be resumed later with `work plan`.

**Details:**
- Working package: `./packages/workstreams`
- Note: This may require changes to how `work create` invokes the planning agent
- Options to investigate:
  1. If `work create` already runs opencode, add tracking ID to title and capture session after
  2. If `work create` doesn't run opencode yet, this thread may just document the manual flow
- For now, implement a way to manually set the planning session: `work plan --set <sessionId>`
- This allows users to run `work plan --set ses_xxx` after creating a workstream
- The auto-capture can be added later when we understand the full `work create` flow
