# Plan: Migrate Github Issues To Threads

> **Stream ID:** 012-migrate-github-issues-to-threads | **Created:** 2026-01-24 | **Generated by:** @agenv/workstreams@0.1.0

## Summary

GitHub issues are conceptually thread-level data (one issue per thread), but are currently stored in `tasks.json` on individual tasks. This causes issues to not appear in `threads.json` where they belong. This workstream migrates GitHub issue storage to `threads.json` as the source of truth and updates all sync operations to read/write from there.

## References

- `packages/workstreams/src/lib/threads.ts` - Thread metadata storage, includes `setThreadGitHubIssue()` and migration utilities
- `packages/workstreams/src/lib/github/issues.ts` - `storeThreadIssueMeta()` writes to tasks.json (needs to write to threads.json)
- `packages/workstreams/src/lib/github/sync.ts` - Uses `storeThreadIssueMeta()` to store issue metadata
- `packages/workstreams/src/lib/tasks.ts` - Task CRUD, `discoverThreadsInBatch()` reads `githubIssue` from first task
- `packages/workstreams/src/cli/github.ts` - CLI commands that call `storeThreadIssueMeta()`

## Stages

### Stage 01: Core Migration

#### Stage Definition

Update the GitHub issue storage layer to use `threads.json` as the source of truth instead of storing on tasks in `tasks.json`.

#### Stage Constitution

- **Inputs:** Current codebase with dual storage (`github_issue` in tasks, `githubIssue` in threads)
- **Structure:** Two parallel threads - one for the storage layer, one for the sync operations
- **Outputs:** All GitHub issue CRUD operations read/write from `threads.json`

#### Stage Questions

- [x] Should we keep `github_issue` on tasks for backward compatibility? **No, we'll remove it after migration is complete. The `migrateFromTasksJson` function already handles copying from tasks to threads.**

#### Stage Batches

##### Batch 01: Storage Layer Updates

Update the core storage functions to use threads.json as the source of truth for GitHub issues.

###### Thread 01: Issue Storage Functions

**Summary:**
Update `storeThreadIssueMeta()` and related functions to write to `threads.json` instead of `tasks.json`.

**Details:**
- Working packages: `packages/workstreams/src/lib/github/issues.ts`
- Update `storeThreadIssueMeta()` to call `setThreadGitHubIssue()` from threads.ts instead of modifying task.github_issue
- Ensure it creates thread metadata entry if it doesn't exist
- Keep the function signature compatible (still accepts taskId, extracts threadId from it)

###### Thread 02: Sync Operations

**Summary:**
Update sync operations in `sync.ts` to read GitHub issue state from `threads.json`.

**Details:**
- Working packages: `packages/workstreams/src/lib/github/sync.ts`
- Update `closeThreadIssuesForCompletedThreads()` to read issue data from threads.json via `getThreadGitHubIssue()`
- Update `reopenIssuesForIncompleteThreads()` to read from threads.json
- Update `updateIssueState()` helper to write state changes to threads.json via `setThreadGitHubIssue()`

### Stage 02: Cleanup & Verification

#### Stage Definition

Remove deprecated `github_issue` field from tasks, update consumers, and verify the migration works correctly.

#### Stage Constitution

- **Inputs:** Updated storage layer from Stage 01
- **Structure:** Single batch with cleanup and testing threads
- **Outputs:** Clean codebase with no `github_issue` references on tasks, passing tests

#### Stage Questions

- [x] Should we add a migration command for existing workstreams? **Yes, the existing `migrateFromTasksJson()` function should be enhanced or a new CLI command added.**

#### Stage Batches

##### Batch 01: Cleanup & Testing

Remove deprecated code and verify functionality.

###### Thread 01: Remove Task-Level Issue Storage

**Summary:**
Remove `github_issue` from Task type and update all code that reads from it.

**Details:**
- Working packages: `packages/workstreams/src/lib/types.ts`, `packages/workstreams/src/lib/tasks.ts`
- Remove `github_issue` from Task interface in types.ts
- Update `discoverThreadsInBatch()` in tasks.ts to read from threads.json instead of first task's github_issue
- Update any other code that reads `task.github_issue`

###### Thread 02: Add Migration Command

**Summary:**
Add CLI command to migrate existing workstreams' GitHub issues from tasks.json to threads.json.

**Details:**
- Working packages: `packages/workstreams/src/cli/github.ts`
- Add `work github migrate-issues` command that:
  1. Reads all tasks with `github_issue` from tasks.json
  2. Groups by thread ID
  3. Writes to threads.json via `setThreadGitHubIssue()`
  4. Optionally clears `github_issue` from tasks

###### Thread 03: Tests

**Summary:**
Add/update tests to verify GitHub issue storage works correctly with threads.json.

**Details:**
- Working packages: `packages/workstreams/tests`
- Test `storeThreadIssueMeta()` writes to threads.json
- Test `getThreadGitHubIssue()` returns correct data
- Test sync operations read/write from threads.json
- Test migration command works for existing workstreams

---

*Last updated: 2026-01-24*
