# Plan: Streamlined Workflow

> **Stream ID:** 004-streamlined-workflow | **Created:** 2026-01-22 | **Generated by:** @agenv/workstreams@0.1.0

## Summary

Simplify the workstreams workflow by automating intermediate steps. Currently users must run multiple commands (`work tasks generate`, `work tasks serialize`, `work prompts`) between approval gates. This workstream consolidates these into automatic actions triggered by approvals, reducing the workflow from 10+ steps to 5 core interactions:

1. User prompts planner agent → planner creates PLAN.md
2. User runs `work approve plan` → TASKS.md auto-generated
3. Planner edits TASKS.md (assigns agents) → user runs `work approve tasks`
4. On tasks approval → tasks.json + prompts auto-generated
5. User runs `work start` → execution begins

## References

- Working packages: `./packages/workstreams`
- CLI entry: `./packages/workstreams/bin/work.ts`
- Task MD library: `./packages/workstreams/src/lib/tasks-md.ts`
- Agents library: `./packages/workstreams/src/lib/agents.ts`
- Agents YAML library: `./packages/workstreams/src/lib/agents-yaml.ts`
- Approval library: `./packages/workstreams/src/lib/approval.ts`
- Prompts library: `./packages/workstreams/src/lib/prompts.ts`
- Types: `./packages/workstreams/src/lib/types.ts`
- README: `./packages/workstreams/README.md`

## Stages

### Stage 01: TASKS.md Agent Assignment Support

#### Stage Definition

Extend the TASKS.md structured text format to support agent assignment per thread. Update `work agents` command to use agents.yaml (removing AGENTS.md support) and provide machine-readable output for planner agents.

#### Stage Constitution

**Inputs:**
- Current TASKS.md format specification in `tasks-md.ts`
- Current agents.yaml schema in `agents-yaml.ts`
- Current `work agents` CLI in `src/cli/agents.ts`

**Structure:**
- TASKS.md will support a new syntax: `@agent:agent-name` at the thread level
- `work agents` will output formatted agent info from agents.yaml
- AGENTS.md support will be deprecated but not removed yet

**Outputs:**
- Updated TASKS.md parser that extracts `assigned_agent` per thread
- Updated `work agents` command that reads from agents.yaml
- Type definitions for the new format

#### Stage Questions

- [x] Where should the agent assignment appear in TASKS.md? **At the thread header line**
- [x] Should we support per-task agent assignment or just per-thread? **Per-thread only (simpler)**

#### Stage Batches

##### Batch 01: TASKS.md Format Extension

Extend the TASKS.md format to support agent assignment syntax.

###### Thread 01: Tasks MD Parser

**Summary:**
Update tasks-md.ts to parse and generate agent assignments in TASKS.md format.

**Details:**
- Working package: `./packages/workstreams/src/lib/tasks-md.ts`
- New syntax for thread headers: `#### Thread 01: Router @agent:backend-expert`
- Parser must extract agent name from thread header
- Generator must include agent assignment in output
- Serializer must apply assigned_agent to all tasks in that thread

Example TASKS.md with agent assignment:
```markdown
## Stage 01: Setup
### Batch 01: Core
#### Thread 01: Router @agent:backend-expert
- [ ] Task 01.01.01.01: Create route definitions
- [ ] Task 01.01.01.02: Add middleware chain
```

###### Thread 02: Type Definitions

**Summary:**
Update type definitions to support agent assignment in TASKS.md parsing.

**Details:**
- Working package: `./packages/workstreams/src/lib/types.ts`
- Add `assigned_agent?: string` to thread-level parsing types
- Ensure compatibility with existing Task type

##### Batch 02: Agents Command Update

Update the `work agents` command to use agents.yaml exclusively.

###### Thread 01: Agents YAML Integration

**Summary:**
Modify `work agents` CLI to read from agents.yaml and provide formatted output.

**Details:**
- Working package: `./packages/workstreams/src/cli/agents.ts`
- Remove AGENTS.md reading logic
- Read from agents.yaml using existing `loadAgentsYaml()` function
- Output format should be suitable for planner agents:
  ```
  Available Agents:

  - backend-expert
    Description: Specializes in database schema design...
    Best for: Database setup, migration scripts...
    Models: anthropic/claude-opus, anthropic/claude-sonnet-4
  ```
- Add `--json` flag for machine-readable output

###### Thread 02: AGENTS.md Deprecation

**Summary:**
Remove AGENTS.md support from the codebase and update references.

**Details:**
- Working packages:
  - `./packages/workstreams/src/lib/agents.ts` - deprecate/remove
  - `./packages/workstreams/src/cli/agents.ts` - remove AGENTS.md commands
- Remove `--add` and `--remove` flags that modify AGENTS.md
- Update any code that falls back to AGENTS.md
- Keep the file `agents.ts` but gut the AGENTS.md-specific functions

### Stage 02: Auto-Generate TASKS.md on Plan Approval

#### Stage Definition

When the user runs `work approve plan`, automatically generate TASKS.md from PLAN.md structure. This removes the need for the user to manually run `work tasks generate`.

#### Stage Constitution

**Inputs:**
- Approved PLAN.md
- Current approval flow in `src/lib/approval.ts` and `src/cli/approve.ts`
- Current `work tasks generate` logic in `src/cli/tasks.ts` and `src/lib/tasks-md.ts`

**Structure:**
- After plan validation passes, call `generateTasksMdFromPlan()` automatically
- Add success message indicating TASKS.md was generated
- Handle case where TASKS.md already exists (overwrite with warning)

**Outputs:**
- Modified approval flow that auto-generates TASKS.md
- TASKS.md file created immediately after plan approval

#### Stage Questions

- [x] Should we overwrite existing TASKS.md on re-approval? **Yes, with warning message**
- [x] Should we preserve existing task content if TASKS.md exists? **No, regenerate from PLAN.md**

#### Stage Batches

##### Batch 01: Approval Flow Modification

###### Thread 01: Plan Approval Integration

**Summary:**
Integrate TASKS.md generation into the plan approval flow.

**Details:**
- Working packages:
  - `./packages/workstreams/src/cli/approve.ts`
  - `./packages/workstreams/src/lib/approval.ts`
- After `approvePlan()` succeeds, call `generateTasksMd()`
- Import necessary functions from tasks-md.ts
- Output: "Plan approved. TASKS.md generated at work/{streamId}/TASKS.md"
- Handle edge cases:
  - TASKS.md already exists → overwrite with warning
  - Generation fails → still approve plan but warn user

### Stage 03: Auto-Generate tasks.json and Prompts on Tasks Approval

#### Stage Definition

When the user runs `work approve tasks`, automatically serialize TASKS.md to tasks.json and generate all prompts. This removes the need for `work tasks serialize` and `work prompts` commands in the normal workflow.

#### Stage Constitution

**Inputs:**
- TASKS.md with agent assignments
- Current `work tasks serialize` logic
- Current `work prompts` generation logic in `src/lib/prompts.ts`

**Structure:**
- Tasks approval validates TASKS.md has content
- After validation, serialize to tasks.json
- After serialization, generate all prompts
- Delete TASKS.md after successful serialization

**Outputs:**
- tasks.json populated with all tasks and agent assignments
- Prompts generated for all threads in `work/{streamId}/prompts/`
- TASKS.md deleted (intermediate file no longer needed)

#### Stage Questions

- [x] Should prompts approval be merged into tasks approval? **No, keep as separate gate for flexibility**
- [x] Should TASKS.md be deleted after serialization? **Yes, it's intermediate**

#### Stage Batches

##### Batch 01: Serialization Integration

###### Thread 01: Tasks Approval Integration

**Summary:**
Integrate tasks.json serialization and prompt generation into tasks approval.

**Details:**
- Working packages:
  - `./packages/workstreams/src/cli/approve.ts`
  - `./packages/workstreams/src/lib/approval.ts`
- After tasks validation passes:
  1. Call `serializeTasksMd()` to create tasks.json
  2. Call `generateAllPrompts()` to create prompt files
  3. Delete TASKS.md
- Update success message: "Tasks approved. tasks.json and prompts generated."
- Handle edge cases:
  - Serialization fails → don't approve, show error
  - Prompt generation fails → still approve but warn (tasks.json is the critical artifact)

###### Thread 02: Prompt Generation Library

**Summary:**
Ensure prompt generation can be called programmatically from approval flow.

**Details:**
- Working package: `./packages/workstreams/src/lib/prompts.ts`
- Ensure `generateAllPrompts(repoRoot, streamId)` function exists and is exported
- Should generate prompts for all threads in the workstream
- Return success/failure status and list of generated files

### Stage 04: Documentation and Skill Updates

#### Stage Definition

Update README.md and planning skill documentation to reflect the new streamlined workflow. Keep old commands documented as "advanced" options for edge cases.

#### Stage Constitution

**Inputs:**
- New workflow implementation from stages 1-3
- Current README.md at `./packages/workstreams/README.md`
- Planning skill at `~/.claude/skills/planning-workstreams`

**Structure:**
- Document the new 5-step workflow prominently
- Move old command documentation to "Advanced" or "Manual" section
- Update the planning skill to reflect new flow

**Outputs:**
- Updated README.md with new workflow
- Updated planning skill files

#### Stage Questions

- [x] Should we remove old commands from CLI? **No, keep for backwards compatibility**
- [x] Should old commands show deprecation warnings? **Not yet, just update docs**

#### Stage Batches

##### Batch 01: Documentation Updates

###### Thread 01: README Update

**Summary:**
Update packages/workstreams/README.md with the new streamlined workflow.

**Details:**
- Working package: `./packages/workstreams/README.md`
- New "Quick Start" section showing the 5-step flow:
  1. `work create --name "feature" --stages N`
  2. Fill PLAN.md → `work approve plan` (auto-generates TASKS.md)
  3. Fill TASKS.md with tasks and agents → `work approve tasks` (auto-generates tasks.json + prompts)
  4. `work status` / `work tree` to verify
  5. `work start` to begin execution
- Move `work tasks generate`, `work tasks serialize`, `work prompts` to "Manual Commands" section
- Update the workflow diagram/table
- Add note about agent assignment syntax in TASKS.md

###### Thread 02: Skill Update

**Summary:**
Update the planning-workstreams skill to reflect the new workflow.

**Details:**
- Working file: `~/.claude/skills/planning-workstreams`
- Remove references to `work tasks generate` and `work tasks serialize` in main flow
- Update step-by-step workflow instructions
- Add section about agent assignment in TASKS.md
- Simplify the review checkpoints section

---

*Last updated: 2026-01-22*
