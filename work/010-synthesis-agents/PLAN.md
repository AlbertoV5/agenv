# Plan: Synthesis Agents

> **Stream ID:** 010-synthesis-agents | **Created:** 2026-01-23 | **Generated by:** @agenv/workstreams@0.1.0

## Summary

Add "synthesis agents" - wrapper agents that run working agents and synthesize summaries from their outputs. Synthesis agents observe and summarize what working agents accomplish, with summaries stored in threads.json for use in notifications (future TTS integration).

Key changes:
1. Extend agents.yaml to support `synthesis_agents` section
2. Update `work multi` to wrap thread execution with synthesis agents
3. Track working agent sessions separately from synthesis agent sessions
4. Create `synthesizing-workstreams` skill for synthesis agent behavior
5. Store synthesis output in threads.json
6. Prepare notification system for future TTS integration (add sound queueing)

## References

- `packages/workstreams/src/cli/multi.ts` - Main multi-thread execution
- `packages/workstreams/src/lib/multi-orchestrator.ts` - Thread collection and tmux setup
- `packages/workstreams/src/lib/opencode.ts` - Session listing and command building
- `packages/workstreams/src/lib/agents-yaml.ts` - Agent configuration parsing
- `packages/workstreams/src/lib/prompts.ts` - Prompt generation with skill references
- `packages/workstreams/src/lib/notifications.ts` - Notification system
- `packages/workstreams/src/lib/threads.ts` - Thread metadata storage
- `packages/workstreams/src/lib/types.ts` - Type definitions
- `~/.config/opencode/skills/implementing-workstreams/SKILL.md` - Example skill

## Stages

### Stage 01: Foundation

#### Stage Definition

Establish the core infrastructure for synthesis agents: extend types, parse synthesis_agents from agents.yaml, create the skill file, and double session listing capacity.

#### Stage Constitution

**Inputs:**
- `packages/workstreams/src/lib/agents-yaml.ts` - Current agents.yaml schema and parser
- `packages/workstreams/src/lib/types.ts` - Current type definitions
- `packages/workstreams/src/lib/opencode.ts` - Current session listing code
- `~/.config/opencode/skills/implementing-workstreams/SKILL.md` - Example skill

**Structure:**
- Batch 01: Types first (YAML parser depends on these types)
- Batch 02: YAML parsing, skill creation, and session listing in parallel

**Outputs:**
- Extended types for synthesis agents
- agents-yaml.ts capable of parsing `synthesis_agents` section
- synthesizing-workstreams skill file
- Doubled session listing capacity (--max-count 10 -> 20)

#### Stage Questions

- [x] Where should the skill file be created? ~/.config/opencode/skills/synthesizing-workstreams/SKILL.md

#### Stage Batches

##### Batch 01: Type Definitions

Types must be defined first since the YAML parser imports them.

###### Thread 01: Types and Schema

**Summary:**
Extend type definitions to support synthesis agents in agents.yaml and synthesis output in threads.json.

**Details:**
- Working packages: `./packages/workstreams`
- Add to types.ts:
  - `SynthesisAgentDefinitionYaml` interface (similar to `AgentDefinitionYaml` but for synthesis)
  - Extend `AgentsConfigYaml` to include optional `synthesis_agents?: SynthesisAgentDefinitionYaml[]`
  - Add `synthesisOutput?: string` field to `ThreadMetadata` for storing synthesis summaries
  - Add `workingAgentSessionId?: string` to `ThreadMetadata` to track the working agent's opencode session (distinct from `opencodeSessionId` which tracks the outer/synthesis session)

**Session ID Clarification:**
- `opencodeSessionId`: The opencode session ID of the outermost agent (synthesis agent when enabled, otherwise working agent)
- `workingAgentSessionId`: The opencode session ID of the working agent specifically (only set when synthesis is enabled)
- `currentSessionId`: Internal session tracking ID (not an opencode session)
- For `work fix --resume`, we use `workingAgentSessionId` when available, falling back to `opencodeSessionId`

##### Batch 02: Parser, Skill, and Session Capacity

These can run in parallel after types are defined.

###### Thread 01: YAML Parser Extension

**Summary:**
Extend agents-yaml.ts to parse the new `synthesis_agents` section.

**Details:**
- Working packages: `./packages/workstreams`
- Extend `parseAgentsYaml()` to handle `synthesis_agents` array
- Add `getSynthesisAgent()` function to get a synthesis agent by name
- Add `getDefaultSynthesisAgent()` to get first synthesis agent or null
- Validate synthesis agent models same as regular agents

**Example agents.yaml schema:**
```yaml
agents:
  - name: default
    description: General-purpose implementation agent.
    best_for: Standard development tasks.
    models: [anthropic/claude-sonnet-4-5]

synthesis_agents:
  - name: batch-synthesizer
    description: Summarizes working agent outputs after completion.
    best_for: Generating concise summaries of completed work.
    models: [anthropic/claude-sonnet-4-5]
```

###### Thread 02: Create Synthesizing Skill

**Summary:**
Create the synthesizing-workstreams skill file that synthesis agents will use.

**Details:**
- Create file: `~/.config/opencode/skills/synthesizing-workstreams/SKILL.md`
- Skill instructs agent to:
  1. Run the provided opencode command to execute the working agent
  2. After completion, review the session output
  3. Generate a concise summary (2-3 sentences) of what was accomplished
  4. Output the summary in a specific format for parsing
- Include guidance on summary format: focus on what was done, key changes, any issues
- Test the skill loads correctly with opencode's skill loader

###### Thread 03: Double Session Listing

**Summary:**
Double the session listing capacity from 10 to 20 to handle synthesis agent sessions alongside working agent sessions.

**Details:**
- Working packages: `./packages/workstreams`
- In opencode.ts, find `--max-count 10` in `buildRunCommand()` and `buildRetryRunCommand()`
- Change to `--max-count 20`
- This ensures we can find the working agent session even when multiple synthesis sessions exist

### Stage 02: Integration

#### Stage Definition

Integrate synthesis agents into the multi execution flow. Modify how threads are executed to wrap them with synthesis agents, track working agent sessions correctly, and store synthesis output.

#### Stage Constitution

**Inputs:**
- Extended types and YAML parser from Stage 01
- `packages/workstreams/src/cli/multi.ts` - Current multi.ts execution flow
- `packages/workstreams/src/lib/threads.ts` - Current thread metadata storage

**Structure:**
- Parallel work on command building, session tracking, and output storage
- Sequential integration into multi.ts

**Outputs:**
- Modified command builder for synthesis wrapper
- Working agent session tracking
- Synthesis output storage in threads.json

#### Stage Questions

- [x] How does synthesis agent wrap the working agent? It runs `opencode run` with a prompt that includes the working agent command, then synthesizes after completion
- [x] How to capture working agent session ID? Parse from the synthesis agent's output or use the existing tracking mechanism with temp files

#### Stage Batches

##### Batch 01: Command and Session Building

Build the synthesis wrapper command and session tracking logic.

###### Thread 01: Synthesis Command Builder

**Summary:**
Create function to build the synthesis agent command that wraps the working agent execution.

**Details:**
- Working packages: `./packages/workstreams`
- Add `buildSynthesisRunCommand()` to opencode.ts that wraps `buildRetryRunCommand()` internally
- The synthesis command:
  1. Generates unique tracking IDs for both synthesis and working agents
  2. Runs opencode with the synthesis agent's model
  3. The prompt tells synthesis agent to run the working agent command
  4. After working agent completes, synthesis agent summarizes
  5. Synthesis output is written to a temp file for capture
- The working agent's original command (from buildRetryRunCommand) becomes part of the synthesis prompt
- Track both session IDs in separate temp files
- Use streamId prefix for temp files: `/tmp/workstream-{streamId}-{threadId}-synthesis.txt`

**Error Handling:**
- If synthesis agent fails, still capture working agent session ID if available
- If working agent crashes, synthesis agent should note this in summary
- If synthesis output file is empty/missing, log warning but don't fail the thread

###### Thread 02: Working Session Tracker

**Summary:**
Add logic to track and store the working agent session ID separately from synthesis session.

**Details:**
- Working packages: `./packages/workstreams`
- Extend threads.ts with functions:
  - `setWorkingAgentSessionId(repoRoot, streamId, threadId, sessionId)`
  - `getWorkingAgentSessionId(repoRoot, streamId, threadId)`
- The working agent session ID is what we want to use for `work fix --resume`
- Update multi.ts session close handler to capture and store both session IDs

##### Batch 02: Multi Integration

Integrate synthesis agents into the multi execution flow.

###### Thread 01: Multi Orchestrator Update

**Summary:**
Update multi.ts and multi-orchestrator.ts to use synthesis agents when available.

**Details:**
- Working packages: `./packages/workstreams`
- In multi.ts main():
  1. Load synthesis agent config (getDefaultSynthesisAgent)
  2. If synthesis agent exists, use buildSynthesisRunCommand instead of buildRetryRunCommand
  3. Pass both working agent models and synthesis agent model to command builder
- In collectThreadInfoFromTasks():
  - Add optional synthesisAgentName and synthesisModels to ThreadInfo
- Update setupTmuxSession to handle synthesis commands
- Ensure session close handler captures working agent session ID for threads.json

###### Thread 02: Synthesis Output Storage

**Summary:**
Capture and store synthesis output in threads.json after thread completion.

**Details:**
- Working packages: `./packages/workstreams`
- In multi.ts handleSessionClose():
  1. Read synthesis output from temp file (uses streamId prefix: `/tmp/workstream-{streamId}-{threadId}-synthesis.txt`)
  2. Call updateThreadMetadataLocked with synthesisOutput
  3. Log warning if synthesis output is empty/missing but continue normally
- Add temp file path helper: `getSynthesisOutputPath(streamId, threadId)` in opencode.ts
- Add cleanup for synthesis output temp files in marker-polling.ts

**Error Handling:**
- Missing synthesis file: Log warning, set synthesisOutput to null
- Empty synthesis file: Log warning, set synthesisOutput to empty string
- Malformed content: Store as-is (synthesis agent responsible for format)

### Stage 03: Notification Enhancements

#### Stage Definition

Prepare the notification system for future TTS integration by adding sound queueing capability and exposing synthesis output through the notification payload.

#### Stage Constitution

**Inputs:**
- `packages/workstreams/src/lib/notifications.ts` - Current notifications.ts architecture
- Synthesis output stored in `threads.json` from Stage 02

**Structure:**
- Add sound queue to prevent overlapping sounds
- Extend notification payload to include synthesis summary

**Outputs:**
- NotificationManager with sound queueing
- Notification payload includes synthesis output
- Ready for TTS service integration

#### Stage Questions

- [x] Should sounds queue or skip if one is playing? Queue - ensures all notifications are heard
- [x] How does TTS fit in? Future ExternalApiProvider or TTSProvider would receive synthesis output in payload

#### Stage Batches

##### Batch 01: Notification Enhancements

Enhance notification system for future TTS integration.

###### Thread 01: Sound Queue Implementation

**Summary:**
Add sound queueing to MacOSSoundProvider to prevent overlapping sounds when multiple threads complete simultaneously.

**Details:**
- Working packages: `./packages/workstreams`
- Modify MacOSSoundProvider class:
  - Add private queue: string[] for pending sound paths
  - Add isPlaying: boolean flag
  - Modify playNotification to queue sounds instead of spawning immediately
  - Add playNext() method to play from queue when current sound finishes
  - Use afplay's exit event to trigger next sound
- This prepares for TTS where we'd want summaries read sequentially

###### Thread 02: Notification Payload Extension

**Summary:**
Extend webhook payload and notification events to include synthesis output for future TTS.

**Details:**
- Working packages: `./packages/workstreams`
- Extend NotificationEvent type or add new event: "thread_synthesis_complete"
- Add metadata option to playNotification for passing synthesis output
- Extend WebhookPayload to include synthesisOutput field
- Update NotificationTracker to accept and pass through synthesis data
- Add helper method: playSynthesisComplete(threadId, synthesisOutput)
- This sets up the interface for a future TTSProvider to receive summaries
- Maintain backward compatibility: existing notification consumers unaffected

### Stage 04: Documentation

#### Stage Definition

Document the synthesis agents feature for users and future maintainers.

#### Stage Constitution

**Inputs:**
- Completed implementation from Stages 01-03
- Existing skill files as examples

**Structure:**
- Single thread for documentation updates

**Outputs:**
- Updated README or docs with synthesis agent configuration
- Inline code documentation

#### Stage Questions

- [x] Where should documentation live? In the skill file and inline code comments (no separate docs folder exists)

#### Stage Batches

##### Batch 01: Documentation

###### Thread 01: Documentation Updates

**Summary:**
Document synthesis agents configuration and usage.

**Details:**
- Working packages: `./packages/workstreams`
- Update synthesizing-workstreams skill with complete usage instructions
- Add JSDoc comments to new functions in agents-yaml.ts, opencode.ts, threads.ts
- Add inline comments explaining session ID relationships in types.ts
- Document the agents.yaml schema for synthesis_agents in code comments

---

*Last updated: 2026-01-23*
