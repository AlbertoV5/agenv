# Plan: Session Tracking

> **Stream ID:** 005-session-tracking | **Created:** 2026-01-22 | **Generated by:** @agenv/workstreams@0.1.0

## Summary

Enhance the workstreams CLI to track opencode sessions per thread, enabling resumption of incomplete work and targeted fixes. This includes renaming `work fix` to `work add stage` (more semantically accurate) and creating a new `work fix` command that offers options to resume specific threads or create new fix stages.

**Key Goals:**
1. Persist opencode session IDs linked to threads in `tasks.json`
2. Track session completion status and agent assignments
3. Enable `work fix` to offer interactive options: resume existing thread, retry with different agent, or create new fix stage
4. Rename current `work fix` to `work add stage` for clarity

## References

- `packages/workstreams/src/cli/fix.ts` - Current fix command implementation
- `packages/workstreams/src/cli/execute.ts` - Thread execution logic
- `packages/workstreams/src/cli/multi.ts` - Batch parallel execution
- `packages/workstreams/src/lib/tmux.ts` - Tmux session management
- `packages/workstreams/src/lib/tasks.ts` - Task state management
- `packages/workstreams/src/types/tasks.ts` - Task type definitions

## Stages

### Stage 01: Session Tracking Infrastructure

#### Stage Definition

Build the foundational infrastructure to track opencode sessions per thread. This includes schema updates, session capture during execution, and persistence to `tasks.json`.

#### Stage Constitution

**Inputs:**
- Current `tasks.json` schema and Task type definitions
- Execute and multi command implementations
- Opencode session ID format and retrieval methods

**Structure:**
- Batch 1: Schema and type updates (parallel: types + validation)
- Batch 2: Session capture integration (depends on Batch 1)

**Outputs:**
- Extended Task type with session tracking fields
- Updated execute/multi commands that record session IDs
- Session history persisted in tasks.json

#### Stage Questions

- [x] How to capture opencode session ID? Via `opencode run --print-session-id` flag or parse from output
- [x] Should we track multiple sessions per thread (retries)? Yes, store as array with timestamps

#### Stage Batches

##### Batch 01: Schema Extensions

Extend the Task type and tasks.json schema to support session tracking.

###### Thread 01: Type Definitions

**Summary:**
Update TypeScript types to include session tracking fields.

**Details:**
- Working package: `./packages/workstreams`
- Update `src/types/tasks.ts` to add session tracking:
  ```typescript
  interface SessionRecord {
    sessionId: string
    agentName: string
    model: string
    startedAt: string  // ISO timestamp
    completedAt?: string
    status: 'running' | 'completed' | 'failed' | 'interrupted'
    exitCode?: number
  }

  interface Task {
    // ... existing fields
    sessions?: SessionRecord[]  // Array to track retries
    currentSessionId?: string   // Active session for resume
  }
  ```
- Ensure backwards compatibility with existing tasks.json files

###### Thread 02: Schema Validation

**Summary:**
Update JSON schema validation to handle new session fields.

**Details:**
- Working package: `./packages/workstreams`
- Update `src/lib/tasks.ts` validation functions
- Add migration logic for existing tasks.json files (add empty sessions array)
- Ensure `work validate` handles new schema gracefully

##### Batch 02: Session Capture

Integrate session ID capture into execution commands.

###### Thread 01: Execute Command Integration

**Summary:**
Update `work execute` to capture and persist session IDs.

**Details:**
- Working package: `./packages/workstreams`
- Modify `src/cli/execute.ts`:
  1. Before spawning opencode, generate or capture session ID
  2. Create SessionRecord with status 'running'
  3. Update task in tasks.json with currentSessionId
  4. On completion, update SessionRecord status and exitCode
  5. Clear currentSessionId, keep session in history array
- Handle both TUI mode and piped mode
- Consider: opencode may need flag to output session ID

###### Thread 02: Multi Command Integration

**Summary:**
Update `work multi` to track sessions for parallel threads.

**Details:**
- Working package: `./packages/workstreams`
- Modify `src/cli/multi.ts`:
  1. For each thread window, capture session ID before spawn
  2. Update tasks.json atomically (file locking consideration)
  3. Track session status per window
  4. On batch completion, update all session statuses
- Integrate with tmux window tracking in `src/lib/tmux.ts`
- Handle race conditions with multiple parallel writes

### Stage 02: Command Refactoring

#### Stage Definition

Rename the existing `work fix` command to `work add stage` and create a new intelligent `work fix` command that offers resume capabilities.

#### Stage Constitution

**Inputs:**
- Completed session tracking infrastructure from Stage 1
- `packages/workstreams/src/cli/fix.ts` current implementation
- User workflow requirements for fixing failed threads

**Structure:**
- Batch 1: Rename fix to add-stage (single focused change)
- Batch 2: New fix command with resume logic (parallel: core logic + interactive UI)

**Outputs:**
- `work add stage` command (renamed from fix)
- New `work fix` command with interactive options
- Updated help text and CLI documentation

#### Stage Questions

- [x] Should `work add-stage` be hyphenated or `work add stage`? Use `work add-stage` to match existing patterns (add-batch, add-thread)
- [x] What fix options to offer? Resume session, retry with same agent, retry with different agent, create new stage

#### Stage Batches

##### Batch 01: Rename Fix to Add-Stage

Rename the existing fix command while maintaining backwards compatibility.

###### Thread 01: Command Rename

**Summary:**
Rename `work fix` to `work add-stage` and update all references.

**Details:**
- Working package: `./packages/workstreams`
- Rename `src/cli/fix.ts` to `src/cli/add-stage.ts`
- Update command registration in `src/cli/index.ts` or main router
- Update command name and help text inside the file
- Add deprecation alias: `work fix` shows warning and forwards to `work add-stage`
- Update skill documentation in `./skills/planning-workstreams/SKILL.md`
- Keep functionality identical, only rename

##### Batch 02: New Fix Command

Create the new intelligent fix command with resume capabilities.

###### Thread 01: Fix Command Core

**Summary:**
Implement core logic for the new `work fix` command.

**Details:**
- Working package: `./packages/workstreams`
- Create new `src/cli/fix.ts` with resume logic:
  1. List threads with incomplete/failed status
  2. Show session history for each problematic thread
  3. Implement resume logic using stored session ID
  4. Implement retry logic (same agent, different model)
  5. Implement agent swap logic (different agent entirely)
  6. Fall back to `work add-stage` if user wants new stage
- Options:
  ```
  work fix                    # Interactive mode
  work fix --thread "01.01.02" --resume    # Resume specific session
  work fix --thread "01.01.02" --retry     # Retry with same agent
  work fix --thread "01.01.02" --agent X   # Retry with different agent
  work fix --new-stage                     # Alias for work add-stage
  ```

###### Thread 02: Interactive UI

**Summary:**
Build interactive prompts for fix command.

**Details:**
- Working package: `./packages/workstreams`
- Use prompts library (or similar) for interactive selection
- Display thread status table:
  ```
  Thread          Status      Sessions  Last Agent
  01.01.01        completed   1         backend-expert
  01.01.02        failed      2         backend-expert
  01.02.01        incomplete  1         frontend-dev
  ```
- Prompt for thread selection (if not specified via flag)
- Prompt for action: Resume | Retry | Change Agent | New Stage
- If changing agent, show available agents from `agents.yaml`
- Confirm action before execution

### Stage 03: Integration and Polish

#### Stage Definition

Wire everything together, add comprehensive error handling, and ensure smooth user experience across all fix workflows.

#### Stage Constitution

**Inputs:**
- Session tracking from Stage 1
- New commands from Stage 2
- Real-world usage patterns

**Structure:**
- Batch 1: Integration and continue command update (parallel threads)
- Batch 2: Documentation and testing (depends on Batch 1)

**Outputs:**
- Fully integrated fix workflow
- Updated `work continue` with session awareness
- Updated documentation and help text

#### Stage Questions

- [x] Should `work continue` auto-detect and offer to fix failed threads? Yes, show summary and offer fix option

#### Stage Batches

##### Batch 01: Integration

Connect all pieces and update related commands.

###### Thread 01: Continue Command Update

**Summary:**
Update `work continue` to be session-aware and offer fix options.

**Details:**
- Working package: `./packages/workstreams`
- Modify `src/cli/continue.ts`:
  1. Check for incomplete/failed threads with session history
  2. Display summary: "Found 2 incomplete threads from previous run"
  3. Offer options: Continue (skip failed), Fix first, Abort
  4. If "Fix first", delegate to `work fix` interactive mode
- Improve status reporting to show session context

###### Thread 02: Status Command Enhancement

**Summary:**
Enhance `work status` to show session information.

**Details:**
- Working package: `./packages/workstreams`
- Update `src/cli/status.ts` to display:
  - Session count per thread
  - Last session status and timestamp
  - Current running sessions (if any)
  - Resumable threads indicator
- Add `--sessions` flag for detailed session history view
- Format output for readability

##### Batch 02: Documentation and Testing

Update documentation and ensure reliability.

###### Thread 01: Documentation Updates

**Summary:**
Update all documentation to reflect new commands and workflows.

**Details:**
- Working packages: `./packages/workstreams`, `././skills`
- Update `./skills/planning-workstreams/SKILL.md` CLI reference
- Update `./skills/implementing-workstreams/SKILL.md` with fix workflow
- Update any README files in workstreams package
- Add examples for common fix scenarios
- Document session tracking behavior

###### Thread 02: Error Handling

**Summary:**
Add comprehensive error handling across session tracking features.

**Details:**
- Working package: `./packages/workstreams`
- Handle cases:
  - Session ID not available (opencode version mismatch)
  - Stale session (can't resume old sessions)
  - Concurrent writes to tasks.json
  - Missing or corrupted session records
- Add graceful degradation if session tracking fails
- Log warnings for debugging
- Ensure existing workflows continue to work even if session tracking fails

---

*Last updated: 2026-01-22*
