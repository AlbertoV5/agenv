# Plan: Opencode Workstream Commands

> **Stream ID:** 013-opencode-workstream-commands | **Created:** 2026-01-25 | **Generated by:** @agenv/workstreams@0.1.0

## Summary

Reorganize agent resources (skills, commands, tools, plugins, hooks) into a dedicated `agent/` directory at the repository root, then create opencode custom commands with a `w:` prefix to expose workstream CLI functionality directly within opencode sessions. This consolidates scattered agent configuration and enables seamless workstream management from within opencode.

## References

- `skills/` - Current location of skills (to be moved)
- `tools/` - Current location of tools (to be moved)
- `plugins/` - Current location of plugins (to be moved)
- `hooks/` - Current location of hooks (to be moved)
- `packages/cli/src/commands/install.ts` - Install command to update
- `install.sh` - Shell installer to update

## Stages

### Stage 01: Agent Package Reorganization

#### Stage Definition

Create the `agent/` directory structure and migrate all existing agent resources (skills, tools, plugins, hooks) from their current scattered locations. Update the install command to use the new centralized paths.

#### Stage Constitution

**Inputs:**
- Existing `./skills/` directory with 5 workstream skills
- Existing `./tools/` directory with `workstream.ts`
- Existing `./plugins/` directory with `setup-env.ts`
- Existing `./hooks/` directory with `hooks.json`
- `packages/cli/src/commands/install.ts` for path updates

**Structure:**
- New `agent/` directory at repo root
- Subdirectories: `skills/`, `commands/`, `tools/`, `plugins/`, `hooks/`
- Update install.ts to reference `agent/` paths instead of root-level directories

**Outputs:**
- `agent/` directory with all resources organized
- Old directories removed or emptied
- Updated install command working with new paths

#### Stage Questions

- [x] What should the new directory be named? **Answer: `agent/` - simple, clear, descriptive**
- [x] Should we keep backward compatibility with old paths? **Answer: No, clean migration - update all references**

#### Stage Batches

##### Batch 01: Directory Structure & Migration

Create the new directory structure and move existing files.

###### Thread 01: Create Agent Directory Structure

**Summary:**
Create the `agent/` directory with all subdirectories and move existing resources.

**Details:**
- Working packages: Root directory
- Create `agent/` with subdirectories:
  - `agent/skills/` - Move from `./skills/`
  - `agent/commands/` - New, for opencode slash commands
  - `agent/tools/` - Move from `./tools/`
  - `agent/plugins/` - Move from `./plugins/`
  - `agent/hooks/` - Move from `./hooks/`
- Move all existing files to new locations
- Remove old empty directories
- Update `.gitignore` if needed

##### Batch 02: Update Install Command

Update the CLI install command to use the new paths.

###### Thread 01: Update Install Paths

**Summary:**
Update `packages/cli/src/commands/install.ts` to use `agent/` paths.

**Details:**
- Working packages: `packages/cli`
- Update constants:
  - `AGENV_SKILLS` -> `agent/skills`
  - `AGENV_TOOLS` -> `agent/tools`
  - `AGENV_PLUGINS` -> `agent/plugins`
  - `AGENV_HOOKS` -> `agent/hooks`
- Add new `AGENV_COMMANDS` constant for `agent/commands`
- Add `ag install commands` subcommand for opencode commands
- Update help text to reflect new structure

###### Thread 02: Update Shell Installer

**Summary:**
Update `install.sh` to reflect the new `agent/` structure.

**Details:**
- Update any references to skills/tools/plugins paths
- Update comments and documentation
- Ensure `--skills-only` and related flags work with new paths

### Stage 02: OpenCode Commands Implementation

#### Stage Definition

Create opencode slash commands in `agent/commands/` that wrap workstream CLI functionality. Commands use the `w:` prefix convention (e.g., `/w:status`, `/w:approve-plan`).

#### Stage Constitution

**Inputs:**
- `agent/commands/` directory from Stage 01
- Workstream CLI commands in `packages/workstreams/src/cli/`
- OpenCode command format (markdown with YAML frontmatter)

**Structure:**
- Each command is a `.md` file in `agent/commands/`
- Files use YAML frontmatter for metadata
- Command body contains the prompt template

**Outputs:**
- Complete set of `w:*` commands for workstream management
- Commands installable via `ag install commands --opencode`

#### Stage Questions

- [x] Should commands use `$ARGUMENTS` or positional `$1`, `$2`? **Answer: Use `$ARGUMENTS` for flexibility, `$1` for specific params**

#### Stage Batches

##### Batch 01: Status & Information Commands

Commands for viewing workstream state.

###### Thread 01: Core Status Commands

**Summary:**
Create commands for viewing workstream status and information.

**Details:**
- Commands to create in `agent/commands/`:
  - `w:status.md` - Show workstream progress
  - `w:current.md` - Show/set current workstream
  - `w:context.md` - Show workstream context
  - `w:list.md` - List tasks
  - `w:tree.md` - Show structure tree
  - `w:preview.md` - Preview PLAN.md structure

Example format:
```markdown
---
description: Show workstream status and progress
---

Run `work status $ARGUMENTS` and display the results.
```

###### Thread 02: Agent & Prompt Commands

**Summary:**
Create commands for agent and prompt management.

**Details:**
- Commands to create:
  - `w:agents.md` - List available agents
  - `w:prompt.md` - Generate thread prompt

##### Batch 02: Approval & Lifecycle Commands

Commands for the approval workflow.

###### Thread 01: Approval Commands

**Summary:**
Create commands for approving workstream gates.

**Details:**
- Commands to create:
  - `w:approve-plan.md` - Approve PLAN.md
  - `w:approve-tasks.md` - Approve tasks
  - `w:approve-revision.md` - Approve revision
  - `w:start.md` - Start workstream

##### Batch 03: Task Management Commands

Commands for task updates.

###### Thread 01: Task Commands

**Summary:**
Create commands for task management.

**Details:**
- Commands to create:
  - `w:update.md` - Update task status
  - `w:read.md` - Read task details
  - `w:complete.md` - Mark workstream complete

### Stage 03: Documentation & Verification

#### Stage Definition

Document the new `agent/` structure and opencode commands, then verify everything works correctly.

#### Stage Constitution

**Inputs:**
- Completed `agent/` directory structure
- Implemented opencode commands
- Updated install command

**Structure:**
- Update README.md with new structure
- Create command reference documentation

**Outputs:**
- Updated documentation
- Verified working installation and commands

#### Stage Questions

- [x] Where should command docs live? **Answer: In `docs/opencode-commands.md`**

#### Stage Batches

##### Batch 01: Documentation & Testing

###### Thread 01: Documentation

**Summary:**
Update documentation to reflect the new structure.

**Details:**
- Update `README.md`:
  - Add section on `agent/` directory structure
  - Document `ag install commands` usage
- Create `docs/opencode-commands.md`:
  - Overview of `w:` command prefix
  - Full command reference table
  - Usage examples

###### Thread 02: Verification

**Summary:**
Verify the complete workflow works.

**Details:**
- Test `ag install skills --all`
- Test `ag install commands --opencode`
- Test `ag install tools --opencode`
- Test `ag install plugins --opencode`
- Test each `w:*` command in opencode
- Verify argument passing works

---

*Last updated: 2026-01-25*

### Stage 04: Revision - Remove Commands & Document Bang Syntax

#### Stage Definition

Remove the custom `w:*` opencode commands and document the simpler `!work` bash syntax for running workstream CLI commands directly in opencode.

**Discovery:** OpenCode supports running bash commands directly with `!` prefix (e.g., `!work status`). This is simpler and more direct than custom slash commands, which are prompt templates sent to the agent. Custom commands add unnecessary overhead for CLI execution.

#### Stage Constitution

**Inputs:**
- Existing `agent/commands/` directory (to be removed)
- OpenCode TUI documentation on bash commands

**Structure:**
- Remove `agent/commands/` directory
- Update documentation to explain `!work` syntax
- Remove references to `w:*` commands

**Outputs:**
- Cleaned up `agent/` directory (no commands subdirectory)
- Updated documentation with `!work` usage guide

#### Stage Questions

- [x] Should we keep any commands? **Answer: No, remove all. Will revisit when we identify commands that need agent interpretation.**

#### Stage Batches

##### Batch 01: Cleanup & Documentation

###### Thread 01: Implementation

**Summary:**
Remove commands directory and update documentation to explain the `!work` bash syntax.

**Details:**
- Remove `agent/commands/` directory entirely
- Update `docs/opencode-commands.md` to document `!work` syntax instead of custom commands
- Update `README.md` to remove references to `ag install commands`
- Remove `ag install commands` from the CLI (or keep for future use)
